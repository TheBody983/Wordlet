import{isPing as e,isGetBlockByHeight as t,isGetBlockById as r,isGetLatestBlock as n,isGetEvents as o,isGetAccount as a,isScript as s,isGetTransactionStatus as i,isTransaction as u}from"@onflow/interaction";import{Transaction as c,SendTransactionRequest as g,AccessAPI as l,GetTransactionRequest as d,ExecuteScriptAtLatestBlockRequest as f,GetAccountRequest as m,GetEventsForHeightRangeRequest as p,GetLatestBlockRequest as v,GetBlockByIDRequest as h,GetBlockByHeightRequest as S,PingRequest as I}from"@onflow/protobuf";import{response as y}from"@onflow/response";import{sansPrefix as k,withPrefix as P}from"@onflow/util-address";import{grpc as B}from"@improbable-eng/grpc-web";import{NodeHttpTransport as w}from"@improbable-eng/grpc-web-node-http-transport";import{config as b}from"@onflow/config";var x=function(e,t,r){try{return Promise.resolve(new Promise(function(n,o){B.unary(t,{request:r,host:e,onEnd:function(e){var t=e.statusMessage;e.status===B.Code.OK?n(e.message):o(new Error(t))}})}))}catch(e){return Promise.reject(e)}};B.setDefaultTransport(w());var L=function(e){return Buffer.from(e,"hex")},A=function(e){return Buffer.from(e.padStart(16,0),"hex")};function U(){return(U=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}var E=function(e){return Buffer.from(e).toString("hex")},_=function(e){return Buffer.from(e).toString("hex")},R=function(e){return Buffer.from(e).toString("hex")},T=function(e){return Buffer.from(e).toString("hex")},j=function(B,w){void 0===w&&(w={});try{var j=function(b){return w.node=b,Promise.resolve(B).then(function(b){switch(B=b,!0){case u(B):return function(e,t){void 0===t&&(t={});try{return Promise.resolve(e).then(function(r){e=r;var n=new c;n.setScript(Buffer.from(e.message.cadence,"utf8")),n.setGasLimit(e.message.computeLimit),n.setReferenceBlockId(e.message.refBlock?L(e.message.refBlock):null),n.setPayer(A(k(e.accounts[e.payer].addr))),e.message.arguments.forEach(function(t){return n.addArguments(function(e){return Buffer.from(JSON.stringify(e),"utf8")}(e.arguments[t].asArgument))}),e.authorizations.map(function(t){return e.accounts[t].addr}).reduce(function(e,t){return e.find(function(e){return e===t})?e:[].concat(e,[t])},[]).forEach(function(e){return n.addAuthorizers(A(k(e)))});var o=new c.ProposalKey;o.setAddress(A(k(e.accounts[e.proposer].addr))),o.setKeyId(e.accounts[e.proposer].keyId),o.setSequenceNumber(e.accounts[e.proposer].sequenceNum),n.setProposalKey(o);for(var a=0,s=Object.values(e.accounts);a<s.length;a++){var i=s[a];try{if(!i.role.payer&&null!=i.signature){var u=new c.Signature;u.setAddress(A(k(i.addr))),u.setKeyId(i.keyId),u.setSignature(L(i.signature)),n.addPayloadSignatures(u)}}catch(t){throw console.error("Trouble applying payload signature",{acct:i,ix:e}),t}}for(var d=0,f=Object.values(e.accounts);d<f.length;d++){var m=f[d];try{if(m.role.payer&&null!=m.signature){var p=new c.Signature;p.setAddress(A(k(m.addr))),p.setKeyId(m.keyId),p.setSignature(L(m.signature)),n.addEnvelopeSignatures(p)}}catch(t){throw console.error("Trouble applying envelope signature",{acct:m,ix:e}),t}}var v=new g;v.setTransaction(n);var h=Date.now();return Promise.resolve(x(t.node,l.SendTransaction,v)).then(function(t){var r,n=Date.now(),o=y();return o.tag=e.tag,o.transactionId=(r=t.getId_asU8(),Buffer.from(r).toString("hex")),"undefined"!=typeof window&&window.dispatchEvent(new CustomEvent("FLOW::TX",{detail:{txId:o.transactionId,delta:n-h}})),o})})}catch(e){return Promise.reject(e)}}(B,w);case i(B):return function(e,t){void 0===t&&(t={});try{return Promise.resolve(e).then(function(r){e=r;var n=new d;return n.setId(Buffer.from(e.transactionId,"hex")),Promise.resolve(x(t.node,l.GetTransactionResult,n)).then(function(t){var r=t.getEventsList(),n=y();return n.tag=e.tag,n.transaction={status:t.getStatus(),statusCode:t.getStatusCode(),errorMessage:t.getErrorMessage(),events:r.map(function(e){return{type:e.getType(),transactionId:(t=e.getTransactionId_asU8(),Buffer.from(t).toString("hex")),transactionIndex:e.getTransactionIndex(),eventIndex:e.getEventIndex(),payload:JSON.parse(Buffer.from(e.getPayload_asU8()).toString("utf8"))};var t})},n})})}catch(e){return Promise.reject(e)}}(B,w);case s(B):return function(e,t){void 0===t&&(t={});try{return Promise.resolve(e).then(function(r){e=r;var n=new f,o=Buffer.from(e.message.cadence,"utf8");return e.message.arguments.forEach(function(t){return n.addArguments(function(e){return Buffer.from(JSON.stringify(e),"utf8")}(e.arguments[t].asArgument))}),n.setScript(o),Promise.resolve(x(t.node,l.ExecuteScriptAtLatestBlock,n)).then(function(t){var r=y();return r.tag=e.tag,r.encodedData=JSON.parse(Buffer.from(t.getValue_asU8()).toString("utf8")),r})})}catch(e){return Promise.reject(e)}}(B,w);case a(B):return function(e,t){void 0===t&&(t={});try{return Promise.resolve(e).then(function(r){e=r;var n,o=new m;return o.setAddress((n=k(e.accountAddr),Buffer.from(n.padStart(16,0),"hex"))),Promise.resolve(x(t.node,l.GetAccount,o)).then(function(t){var r=y();r.tag=e.tag;var n,o=t.getAccount(),a=(n=o.getContractsMap())?n.getEntryList().reduce(function(e,t){var r;return U({},e,((r={})[t[0]]=new TextDecoder("utf-8").decode(t[1]||new UInt8Array),r))},{}):{};return r.account={address:P(E(o.getAddress_asU8())),balance:o.getBalance(),code:new TextDecoder("utf-8").decode(o.getCode_asU8()||new UInt8Array),contracts:a,keys:o.getKeysList().map(function(e){return{index:e.getIndex(),publicKey:E(e.getPublicKey_asU8()),signAlgo:e.getSignAlgo(),hashAlgo:e.getHashAlgo(),weight:e.getWeight(),sequenceNumber:e.getSequenceNumber(),revoked:e.getRevoked()}})},r})})}catch(e){return Promise.reject(e)}}(B,w);case o(B):return function(e,t){void 0===t&&(t={});try{return Promise.resolve(e).then(function(r){e=r;var n=new p;return n.setType(e.events.eventType),n.setStartHeight(Number(e.events.start)),n.setEndHeight(Number(e.events.end)),Promise.resolve(x(t.node,l.GetEventsForHeightRange,n)).then(function(t){var r=y();r.tag=e.tag;var n=t.getResultsList();return r.events=n.reduce(function(e,t){var r=t.getBlockId(),n=t.getBlockHeight();return t.getEventsList().forEach(function(t){var o;e.push({blockId:r,blockHeight:n,type:t.getType(),transactionId:(o=t.getTransactionId_asU8(),Buffer.from(o).toString("hex")),transactionIndex:t.getTransactionIndex(),eventIndex:t.getEventIndex(),payload:JSON.parse(Buffer.from(t.getPayload_asU8()).toString("utf8"))})}),e},[]),r})})}catch(e){return Promise.reject(e)}}(B,w);case n(B):return function(e,t){void 0===t&&(t={});try{return Promise.resolve(e).then(function(r){e=r;var n=new v;return e.latestBlock&&e.latestBlock.isSealed&&(n.setIsSealed(e.latestBlock.isSealed),console.error("\n          %c@onflow/send Deprecation Notice\n          ========================\n\n          Operating upon data of the latestBlock field of the interaction object is deprecated and will no longer be recognized in future releases of @onflow/send.\n          Find out more here: https://github.com/onflow/flow-js-sdk/blob/master/packages/send/WARNINGS.md#0001-Deprecating-latestBlock-field\n\n          =======================\n        ".replace(/\n\s+/g,"\n").trim(),"font-weight:bold;font-family:monospace;")),e.block&&e.block.isSealed&&n.setIsSealed(e.block.isSealed),Promise.resolve(x(t.node,l.GetLatestBlock,n)).then(function(t){var r=t.getBlock(),n=r.getCollectionGuaranteesList(),o=r.getBlockSealsList(),a=r.getSignaturesList(),s=y();return s.tag=e.tag,s.block={id:_(r.getId_asU8()),parentId:_(r.getParentId_asU8()),height:r.getHeight(),timestamp:r.getTimestamp(),collectionGuarantees:n.map(function(e){return{collectionId:_(e.getCollectionId_asU8()),signatures:e.getSignaturesList()}}),blockSeals:o.map(function(e){return{blockId:_(e.getBlockId_asU8()),executionReceiptId:_(e.getExecutionReceiptId_asU8()),executionReceiptSignatures:e.getExecutionReceiptSignaturesList(),resultApprovalSignatures:e.getResultApprovalSignaturesList()}}),signatures:a},s})})}catch(e){return Promise.reject(e)}}(B,w);case r(B):return function(e,t){void 0===t&&(t={});try{return Promise.resolve(e).then(function(r){e=r;var n=new h;return n.setId(Buffer.from(e.block.id,"hex")),Promise.resolve(x(t.node,l.GetBlockByID,n)).then(function(t){var r=t.getBlock(),n=r.getCollectionGuaranteesList(),o=r.getBlockSealsList(),a=r.getSignaturesList(),s=y();return s.tag=e.tag,s.block={id:R(r.getId_asU8()),parentId:R(r.getParentId_asU8()),height:r.getHeight(),timestamp:r.getTimestamp(),collectionGuarantees:n.map(function(e){return{collectionId:R(e.getCollectionId_asU8()),signatures:e.getSignaturesList()}}),blockSeals:o.map(function(e){return{blockId:R(e.getBlockId_asU8()),executionReceiptId:R(e.getExecutionReceiptId_asU8()),executionReceiptSignatures:e.getExecutionReceiptSignaturesList(),resultApprovalSignatures:e.getResultApprovalSignaturesList()}}),signatures:a},s})})}catch(e){return Promise.reject(e)}}(B,w);case t(B):return function(e,t){void 0===t&&(t={});try{return Promise.resolve(e).then(function(r){e=r;var n=new S;return n.setHeight(e.block.height),Promise.resolve(x(t.node,l.GetBlockByHeight,n)).then(function(t){var r=t.getBlock(),n=r.getCollectionGuaranteesList(),o=r.getBlockSealsList(),a=r.getSignaturesList(),s=y();return s.tag=e.tag,s.block={id:T(r.getId_asU8()),parentId:T(r.getParentId_asU8()),height:r.getHeight(),timestamp:r.getTimestamp(),collectionGuarantees:n.map(function(e){return{collectionId:T(e.getCollectionId_asU8()),signatures:e.getSignaturesList()}}),blockSeals:o.map(function(e){return{blockId:T(e.getBlockId_asU8()),executionReceiptId:T(e.getExecutionReceiptId_asU8()),executionReceiptSignatures:e.getExecutionReceiptSignaturesList(),resultApprovalSignatures:e.getResultApprovalSignaturesList()}}),signatures:a},s})})}catch(e){return Promise.reject(e)}}(B,w);case e(B):return function(e,t){void 0===t&&(t={});try{return Promise.resolve(e).then(function(r){e=r;var n=new I;return Promise.resolve(x(t.node,l.Ping,n)).then(function(t){var r=y();return r.tag=e.tag,r})})}catch(e){return Promise.reject(e)}}(B,w);default:return B}})},N=w.node;return Promise.resolve(N?j(N):Promise.resolve(b().get("accessNode.api")).then(j))}catch(e){return Promise.reject(e)}};export{j as send};
//# sourceMappingURL=send.module.js.map
