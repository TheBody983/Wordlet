import{isPing as e,isGetBlockByHeight as t,isGetBlockById as a,isGetLatestBlock as n,isGetEvents as s,isGetAccount as o,isScript as r,isGetTransactionStatus as i,isTransaction as c}from"@onflow/interaction";import{Transaction as g,SendTransactionRequest as u,AccessAPI as d,GetTransactionRequest as l,ExecuteScriptAtLatestBlockRequest as f,GetAccountRequest as p,GetEventsForHeightRangeRequest as m,GetLatestBlockRequest as w,GetBlockByIDRequest as S,GetBlockByHeightRequest as I,PingRequest as h}from"@onflow/protobuf";import{response as y}from"@onflow/response";import{sansPrefix as k,withPrefix as B}from"@onflow/util-address";import{grpc as b}from"@improbable-eng/grpc-web";import{NodeHttpTransport as x}from"@improbable-eng/grpc-web-node-http-transport";import{config as v}from"@onflow/config";async function L(e,t,a){return new Promise((n,s)=>{b.unary(t,{request:a,host:e,onEnd:({status:e,statusMessage:t,message:a})=>{e===b.Code.OK?n(a):s(new Error(t))}})})}b.setDefaultTransport(x());const A=e=>Buffer.from(e,"hex"),U=e=>Buffer.from(e.padStart(16,0),"hex");function E(){return(E=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e}).apply(this,arguments)}const _=e=>Buffer.from(e).toString("hex"),R=e=>Buffer.from(e).toString("hex"),T=e=>Buffer.from(e).toString("hex"),N=e=>Buffer.from(e).toString("hex"),G=async(b,x={})=>{switch(x.node=x.node||await v().get("accessNode.api"),b=await b,!0){case c(b):return async function(e,t={}){e=await e;const a=new g;a.setScript(Buffer.from(e.message.cadence,"utf8")),a.setGasLimit(e.message.computeLimit),a.setReferenceBlockId(e.message.refBlock?A(e.message.refBlock):null),a.setPayer(U(k(e.accounts[e.payer].addr))),e.message.arguments.forEach(t=>a.addArguments((e=>Buffer.from(JSON.stringify(e),"utf8"))(e.arguments[t].asArgument))),e.authorizations.map(t=>e.accounts[t].addr).reduce((e,t)=>e.find(e=>e===t)?e:[...e,t],[]).forEach(e=>a.addAuthorizers(U(k(e))));const n=new g.ProposalKey;n.setAddress(U(k(e.accounts[e.proposer].addr))),n.setKeyId(e.accounts[e.proposer].keyId),n.setSequenceNumber(e.accounts[e.proposer].sequenceNum),a.setProposalKey(n);for(let t of Object.values(e.accounts))try{if(!t.role.payer&&null!=t.signature){const e=new g.Signature;e.setAddress(U(k(t.addr))),e.setKeyId(t.keyId),e.setSignature(A(t.signature)),a.addPayloadSignatures(e)}}catch(a){throw console.error("Trouble applying payload signature",{acct:t,ix:e}),a}for(let t of Object.values(e.accounts))try{if(t.role.payer&&null!=t.signature){const e=new g.Signature;e.setAddress(U(k(t.addr))),e.setKeyId(t.keyId),e.setSignature(A(t.signature)),a.addEnvelopeSignatures(e)}}catch(a){throw console.error("Trouble applying envelope signature",{acct:t,ix:e}),a}const s=new u;s.setTransaction(a);var o=Date.now();const r=await L(t.node,d.SendTransaction,s);var i=Date.now();let c=y();var l;return c.tag=e.tag,c.transactionId=(l=r.getId_asU8(),Buffer.from(l).toString("hex")),"undefined"!=typeof window&&window.dispatchEvent(new CustomEvent("FLOW::TX",{detail:{txId:c.transactionId,delta:i-o}})),c}(b,x);case i(b):return async function(e,t={}){e=await e;const a=new l;a.setId(Buffer.from(e.transactionId,"hex"));const n=await L(t.node,d.GetTransactionResult,a);let s=n.getEventsList(),o=y();return o.tag=e.tag,o.transaction={status:n.getStatus(),statusCode:n.getStatusCode(),errorMessage:n.getErrorMessage(),events:s.map(e=>{return{type:e.getType(),transactionId:(t=e.getTransactionId_asU8(),Buffer.from(t).toString("hex")),transactionIndex:e.getTransactionIndex(),eventIndex:e.getEventIndex(),payload:JSON.parse(Buffer.from(e.getPayload_asU8()).toString("utf8"))};var t})},o}(b,x);case r(b):return async function(e,t={}){e=await e;const a=new f,n=Buffer.from(e.message.cadence,"utf8");e.message.arguments.forEach(t=>a.addArguments((e=>Buffer.from(JSON.stringify(e),"utf8"))(e.arguments[t].asArgument))),a.setScript(n);const s=await L(t.node,d.ExecuteScriptAtLatestBlock,a);let o=y();return o.tag=e.tag,o.encodedData=JSON.parse(Buffer.from(s.getValue_asU8()).toString("utf8")),o}(b,x);case o(b):return async function(e,t={}){e=await e;const a=new p;var n;a.setAddress((n=k(e.accountAddr),Buffer.from(n.padStart(16,0),"hex")));const s=await L(t.node,d.GetAccount,a);let o=y();o.tag=e.tag;const r=s.getAccount();let i;const c=(i=r.getContractsMap())?i.getEntryList().reduce((e,t)=>E({},e,{[t[0]]:new TextDecoder("utf-8").decode(t[1]||new UInt8Array)}),{}):{};return o.account={address:B(_(r.getAddress_asU8())),balance:r.getBalance(),code:new TextDecoder("utf-8").decode(r.getCode_asU8()||new UInt8Array),contracts:c,keys:r.getKeysList().map(e=>({index:e.getIndex(),publicKey:_(e.getPublicKey_asU8()),signAlgo:e.getSignAlgo(),hashAlgo:e.getHashAlgo(),weight:e.getWeight(),sequenceNumber:e.getSequenceNumber(),revoked:e.getRevoked()}))},o}(b,x);case s(b):return async function(e,t={}){e=await e;const a=new m;a.setType(e.events.eventType),a.setStartHeight(Number(e.events.start)),a.setEndHeight(Number(e.events.end));const n=await L(t.node,d.GetEventsForHeightRange,a);let s=y();s.tag=e.tag;const o=n.getResultsList();return s.events=o.reduce((e,t)=>{const a=t.getBlockId(),n=t.getBlockHeight();return t.getEventsList().forEach(t=>{var s;e.push({blockId:a,blockHeight:n,type:t.getType(),transactionId:(s=t.getTransactionId_asU8(),Buffer.from(s).toString("hex")),transactionIndex:t.getTransactionIndex(),eventIndex:t.getEventIndex(),payload:JSON.parse(Buffer.from(t.getPayload_asU8()).toString("utf8"))})}),e},[]),s}(b,x);case n(b):return async function(e,t={}){e=await e;const a=new w;e.latestBlock&&e.latestBlock.isSealed&&(a.setIsSealed(e.latestBlock.isSealed),console.error("\n          %c@onflow/send Deprecation Notice\n          ========================\n\n          Operating upon data of the latestBlock field of the interaction object is deprecated and will no longer be recognized in future releases of @onflow/send.\n          Find out more here: https://github.com/onflow/flow-js-sdk/blob/master/packages/send/WARNINGS.md#0001-Deprecating-latestBlock-field\n\n          =======================\n        ".replace(/\n\s+/g,"\n").trim(),"font-weight:bold;font-family:monospace;")),e.block&&e.block.isSealed&&a.setIsSealed(e.block.isSealed);const n=(await L(t.node,d.GetLatestBlock,a)).getBlock(),s=n.getCollectionGuaranteesList(),o=n.getBlockSealsList(),r=n.getSignaturesList(),i=y();return i.tag=e.tag,i.block={id:R(n.getId_asU8()),parentId:R(n.getParentId_asU8()),height:n.getHeight(),timestamp:n.getTimestamp(),collectionGuarantees:s.map(e=>({collectionId:R(e.getCollectionId_asU8()),signatures:e.getSignaturesList()})),blockSeals:o.map(e=>({blockId:R(e.getBlockId_asU8()),executionReceiptId:R(e.getExecutionReceiptId_asU8()),executionReceiptSignatures:e.getExecutionReceiptSignaturesList(),resultApprovalSignatures:e.getResultApprovalSignaturesList()})),signatures:r},i}(b,x);case a(b):return async function(e,t={}){e=await e;const a=new S;a.setId(Buffer.from(e.block.id,"hex"));const n=(await L(t.node,d.GetBlockByID,a)).getBlock(),s=n.getCollectionGuaranteesList(),o=n.getBlockSealsList(),r=n.getSignaturesList(),i=y();return i.tag=e.tag,i.block={id:T(n.getId_asU8()),parentId:T(n.getParentId_asU8()),height:n.getHeight(),timestamp:n.getTimestamp(),collectionGuarantees:s.map(e=>({collectionId:T(e.getCollectionId_asU8()),signatures:e.getSignaturesList()})),blockSeals:o.map(e=>({blockId:T(e.getBlockId_asU8()),executionReceiptId:T(e.getExecutionReceiptId_asU8()),executionReceiptSignatures:e.getExecutionReceiptSignaturesList(),resultApprovalSignatures:e.getResultApprovalSignaturesList()})),signatures:r},i}(b,x);case t(b):return async function(e,t={}){e=await e;const a=new I;a.setHeight(e.block.height);const n=(await L(t.node,d.GetBlockByHeight,a)).getBlock(),s=n.getCollectionGuaranteesList(),o=n.getBlockSealsList(),r=n.getSignaturesList(),i=y();return i.tag=e.tag,i.block={id:N(n.getId_asU8()),parentId:N(n.getParentId_asU8()),height:n.getHeight(),timestamp:n.getTimestamp(),collectionGuarantees:s.map(e=>({collectionId:N(e.getCollectionId_asU8()),signatures:e.getSignaturesList()})),blockSeals:o.map(e=>({blockId:N(e.getBlockId_asU8()),executionReceiptId:N(e.getExecutionReceiptId_asU8()),executionReceiptSignatures:e.getExecutionReceiptSignaturesList(),resultApprovalSignatures:e.getResultApprovalSignaturesList()})),signatures:r},i}(b,x);case e(b):return async function(e,t={}){e=await e;const a=new h;await L(t.node,d.Ping,a);let n=y();return n.tag=e.tag,n}(b,x);default:return b}};export{G as send};
//# sourceMappingURL=send.modern.js.map
