var e=require("@onflow/interaction"),t=require("@onflow/protobuf"),r=require("@onflow/response"),n=require("@onflow/util-address"),s=require("@improbable-eng/grpc-web"),o=require("@improbable-eng/grpc-web-node-http-transport"),a=require("@onflow/config"),i=function(e,t,r){try{return Promise.resolve(new Promise(function(n,o){s.grpc.unary(t,{request:r,host:e,onEnd:function(e){var t=e.statusMessage;e.status===s.grpc.Code.OK?n(e.message):o(new Error(t))}})}))}catch(e){return Promise.reject(e)}};s.grpc.setDefaultTransport(o.NodeHttpTransport());var c=function(e){return Buffer.from(e,"hex")},u=function(e){return Buffer.from(e.padStart(16,0),"hex")};function g(){return(g=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}var l=function(e){return Buffer.from(e).toString("hex")},d=function(e){return Buffer.from(e).toString("hex")},f=function(e){return Buffer.from(e).toString("hex")},p=function(e){return Buffer.from(e).toString("hex")};exports.send=function(s,o){void 0===o&&(o={});try{var m=function(a){return o.node=a,Promise.resolve(s).then(function(a){switch(s=a,!0){case e.isTransaction(s):return function(e,s){void 0===s&&(s={});try{return Promise.resolve(e).then(function(o){e=o;var a=new t.Transaction;a.setScript(Buffer.from(e.message.cadence,"utf8")),a.setGasLimit(e.message.computeLimit),a.setReferenceBlockId(e.message.refBlock?c(e.message.refBlock):null),a.setPayer(u(n.sansPrefix(e.accounts[e.payer].addr))),e.message.arguments.forEach(function(t){return a.addArguments(function(e){return Buffer.from(JSON.stringify(e),"utf8")}(e.arguments[t].asArgument))}),e.authorizations.map(function(t){return e.accounts[t].addr}).reduce(function(e,t){return e.find(function(e){return e===t})?e:[].concat(e,[t])},[]).forEach(function(e){return a.addAuthorizers(u(n.sansPrefix(e)))});var g=new t.Transaction.ProposalKey;g.setAddress(u(n.sansPrefix(e.accounts[e.proposer].addr))),g.setKeyId(e.accounts[e.proposer].keyId),g.setSequenceNumber(e.accounts[e.proposer].sequenceNum),a.setProposalKey(g);for(var l=0,d=Object.values(e.accounts);l<d.length;l++){var f=d[l];try{if(!f.role.payer&&null!=f.signature){var p=new t.Transaction.Signature;p.setAddress(u(n.sansPrefix(f.addr))),p.setKeyId(f.keyId),p.setSignature(c(f.signature)),a.addPayloadSignatures(p)}}catch(t){throw console.error("Trouble applying payload signature",{acct:f,ix:e}),t}}for(var m=0,v=Object.values(e.accounts);m<v.length;m++){var h=v[m];try{if(h.role.payer&&null!=h.signature){var I=new t.Transaction.Signature;I.setAddress(u(n.sansPrefix(h.addr))),I.setKeyId(h.keyId),I.setSignature(c(h.signature)),a.addEnvelopeSignatures(I)}}catch(t){throw console.error("Trouble applying envelope signature",{acct:h,ix:e}),t}}var S=new t.SendTransactionRequest;S.setTransaction(a);var P=Date.now();return Promise.resolve(i(s.node,t.AccessAPI.SendTransaction,S)).then(function(t){var n,s=Date.now(),o=r.response();return o.tag=e.tag,o.transactionId=(n=t.getId_asU8(),Buffer.from(n).toString("hex")),"undefined"!=typeof window&&window.dispatchEvent(new CustomEvent("FLOW::TX",{detail:{txId:o.transactionId,delta:s-P}})),o})})}catch(e){return Promise.reject(e)}}(s,o);case e.isGetTransactionStatus(s):return function(e,n){void 0===n&&(n={});try{return Promise.resolve(e).then(function(s){e=s;var o=new t.GetTransactionRequest;return o.setId(Buffer.from(e.transactionId,"hex")),Promise.resolve(i(n.node,t.AccessAPI.GetTransactionResult,o)).then(function(t){var n=t.getEventsList(),s=r.response();return s.tag=e.tag,s.transaction={status:t.getStatus(),statusCode:t.getStatusCode(),errorMessage:t.getErrorMessage(),events:n.map(function(e){return{type:e.getType(),transactionId:(t=e.getTransactionId_asU8(),Buffer.from(t).toString("hex")),transactionIndex:e.getTransactionIndex(),eventIndex:e.getEventIndex(),payload:JSON.parse(Buffer.from(e.getPayload_asU8()).toString("utf8"))};var t})},s})})}catch(e){return Promise.reject(e)}}(s,o);case e.isScript(s):return function(e,n){void 0===n&&(n={});try{return Promise.resolve(e).then(function(s){e=s;var o=new t.ExecuteScriptAtLatestBlockRequest,a=Buffer.from(e.message.cadence,"utf8");return e.message.arguments.forEach(function(t){return o.addArguments(function(e){return Buffer.from(JSON.stringify(e),"utf8")}(e.arguments[t].asArgument))}),o.setScript(a),Promise.resolve(i(n.node,t.AccessAPI.ExecuteScriptAtLatestBlock,o)).then(function(t){var n=r.response();return n.tag=e.tag,n.encodedData=JSON.parse(Buffer.from(t.getValue_asU8()).toString("utf8")),n})})}catch(e){return Promise.reject(e)}}(s,o);case e.isGetAccount(s):return function(e,s){void 0===s&&(s={});try{return Promise.resolve(e).then(function(o){e=o;var a,c=new t.GetAccountRequest;return c.setAddress((a=n.sansPrefix(e.accountAddr),Buffer.from(a.padStart(16,0),"hex"))),Promise.resolve(i(s.node,t.AccessAPI.GetAccount,c)).then(function(t){var s=r.response();s.tag=e.tag;var o,a=t.getAccount(),i=(o=a.getContractsMap())?o.getEntryList().reduce(function(e,t){var r;return g({},e,((r={})[t[0]]=new TextDecoder("utf-8").decode(t[1]||new UInt8Array),r))},{}):{};return s.account={address:n.withPrefix(l(a.getAddress_asU8())),balance:a.getBalance(),code:new TextDecoder("utf-8").decode(a.getCode_asU8()||new UInt8Array),contracts:i,keys:a.getKeysList().map(function(e){return{index:e.getIndex(),publicKey:l(e.getPublicKey_asU8()),signAlgo:e.getSignAlgo(),hashAlgo:e.getHashAlgo(),weight:e.getWeight(),sequenceNumber:e.getSequenceNumber(),revoked:e.getRevoked()}})},s})})}catch(e){return Promise.reject(e)}}(s,o);case e.isGetEvents(s):return function(e,n){void 0===n&&(n={});try{return Promise.resolve(e).then(function(s){e=s;var o=new t.GetEventsForHeightRangeRequest;return o.setType(e.events.eventType),o.setStartHeight(Number(e.events.start)),o.setEndHeight(Number(e.events.end)),Promise.resolve(i(n.node,t.AccessAPI.GetEventsForHeightRange,o)).then(function(t){var n=r.response();n.tag=e.tag;var s=t.getResultsList();return n.events=s.reduce(function(e,t){var r=t.getBlockId(),n=t.getBlockHeight();return t.getEventsList().forEach(function(t){var s;e.push({blockId:r,blockHeight:n,type:t.getType(),transactionId:(s=t.getTransactionId_asU8(),Buffer.from(s).toString("hex")),transactionIndex:t.getTransactionIndex(),eventIndex:t.getEventIndex(),payload:JSON.parse(Buffer.from(t.getPayload_asU8()).toString("utf8"))})}),e},[]),n})})}catch(e){return Promise.reject(e)}}(s,o);case e.isGetLatestBlock(s):return function(e,n){void 0===n&&(n={});try{return Promise.resolve(e).then(function(s){e=s;var o=new t.GetLatestBlockRequest;return e.latestBlock&&e.latestBlock.isSealed&&(o.setIsSealed(e.latestBlock.isSealed),console.error("\n          %c@onflow/send Deprecation Notice\n          ========================\n\n          Operating upon data of the latestBlock field of the interaction object is deprecated and will no longer be recognized in future releases of @onflow/send.\n          Find out more here: https://github.com/onflow/flow-js-sdk/blob/master/packages/send/WARNINGS.md#0001-Deprecating-latestBlock-field\n\n          =======================\n        ".replace(/\n\s+/g,"\n").trim(),"font-weight:bold;font-family:monospace;")),e.block&&e.block.isSealed&&o.setIsSealed(e.block.isSealed),Promise.resolve(i(n.node,t.AccessAPI.GetLatestBlock,o)).then(function(t){var n=t.getBlock(),s=n.getCollectionGuaranteesList(),o=n.getBlockSealsList(),a=n.getSignaturesList(),i=r.response();return i.tag=e.tag,i.block={id:d(n.getId_asU8()),parentId:d(n.getParentId_asU8()),height:n.getHeight(),timestamp:n.getTimestamp(),collectionGuarantees:s.map(function(e){return{collectionId:d(e.getCollectionId_asU8()),signatures:e.getSignaturesList()}}),blockSeals:o.map(function(e){return{blockId:d(e.getBlockId_asU8()),executionReceiptId:d(e.getExecutionReceiptId_asU8()),executionReceiptSignatures:e.getExecutionReceiptSignaturesList(),resultApprovalSignatures:e.getResultApprovalSignaturesList()}}),signatures:a},i})})}catch(e){return Promise.reject(e)}}(s,o);case e.isGetBlockById(s):return function(e,n){void 0===n&&(n={});try{return Promise.resolve(e).then(function(s){e=s;var o=new t.GetBlockByIDRequest;return o.setId(Buffer.from(e.block.id,"hex")),Promise.resolve(i(n.node,t.AccessAPI.GetBlockByID,o)).then(function(t){var n=t.getBlock(),s=n.getCollectionGuaranteesList(),o=n.getBlockSealsList(),a=n.getSignaturesList(),i=r.response();return i.tag=e.tag,i.block={id:f(n.getId_asU8()),parentId:f(n.getParentId_asU8()),height:n.getHeight(),timestamp:n.getTimestamp(),collectionGuarantees:s.map(function(e){return{collectionId:f(e.getCollectionId_asU8()),signatures:e.getSignaturesList()}}),blockSeals:o.map(function(e){return{blockId:f(e.getBlockId_asU8()),executionReceiptId:f(e.getExecutionReceiptId_asU8()),executionReceiptSignatures:e.getExecutionReceiptSignaturesList(),resultApprovalSignatures:e.getResultApprovalSignaturesList()}}),signatures:a},i})})}catch(e){return Promise.reject(e)}}(s,o);case e.isGetBlockByHeight(s):return function(e,n){void 0===n&&(n={});try{return Promise.resolve(e).then(function(s){e=s;var o=new t.GetBlockByHeightRequest;return o.setHeight(e.block.height),Promise.resolve(i(n.node,t.AccessAPI.GetBlockByHeight,o)).then(function(t){var n=t.getBlock(),s=n.getCollectionGuaranteesList(),o=n.getBlockSealsList(),a=n.getSignaturesList(),i=r.response();return i.tag=e.tag,i.block={id:p(n.getId_asU8()),parentId:p(n.getParentId_asU8()),height:n.getHeight(),timestamp:n.getTimestamp(),collectionGuarantees:s.map(function(e){return{collectionId:p(e.getCollectionId_asU8()),signatures:e.getSignaturesList()}}),blockSeals:o.map(function(e){return{blockId:p(e.getBlockId_asU8()),executionReceiptId:p(e.getExecutionReceiptId_asU8()),executionReceiptSignatures:e.getExecutionReceiptSignaturesList(),resultApprovalSignatures:e.getResultApprovalSignaturesList()}}),signatures:a},i})})}catch(e){return Promise.reject(e)}}(s,o);case e.isPing(s):return function(e,n){void 0===n&&(n={});try{return Promise.resolve(e).then(function(s){e=s;var o=new t.PingRequest;return Promise.resolve(i(n.node,t.AccessAPI.Ping,o)).then(function(t){var n=r.response();return n.tag=e.tag,n})})}catch(e){return Promise.reject(e)}}(s,o);default:return s}})},v=o.node;return Promise.resolve(v?m(v):Promise.resolve(a.config().get("accessNode.api")).then(m))}catch(e){return Promise.reject(e)}};
//# sourceMappingURL=send.js.map
