import{config as e}from"@onflow/config";export{config}from"@onflow/config";import{isTransaction as r,isScript as n,get as t,pipe as o,interaction as i}from"@onflow/interaction";export{isBad,isOk,pipe,why}from"@onflow/interaction";import{invariant as u}from"@onflow/util-invariant";import{latestBlock as a}from"@onflow/sdk-latest-block";export{latestBlock}from"@onflow/sdk-latest-block";import{account as s}from"@onflow/sdk-account";export{account}from"@onflow/sdk-account";import{sansPrefix as c,withPrefix as f}from"@onflow/util-address";export{display,sansPrefix,withPrefix}from"@onflow/util-address";import{encode as d}from"@onflow/rlp";import{resolve as l}from"@onflow/sdk-resolve";import{INIT as m,SUBSCRIBE as p,UPDATED as h,UNSUBSCRIBE as v,SNAPSHOT as y,subscriber as g,spawn as P,snapshoter as b,send as w}from"@onflow/util-actor";import{send as k}from"@onflow/sdk-send";export{send}from"@onflow/sdk-send";import{decode as E}from"@onflow/sdk-decode";export{decode}from"@onflow/sdk-decode";import{getTransactionStatus as I}from"@onflow/sdk-build-transaction-status";export{getTransactionStatus}from"@onflow/sdk-build-transaction-status";export{getEvents}from"@onflow/sdk-build-get-events";import{uid as S}from"@onflow/util-uid";export{template as cadence,template as cdc}from"@onflow/util-template";export{transaction}from"@onflow/sdk-build-transaction";export{script}from"@onflow/sdk-build-script";export{ping}from"@onflow/sdk-build-ping";export{getAccount}from"@onflow/sdk-build-get-account";export{getLatestBlock}from"@onflow/sdk-build-get-latest-block";export{getBlockById}from"@onflow/sdk-build-get-block-by-id";export{getBlockByHeight}from"@onflow/sdk-build-get-block-by-height";export{authorization,authorizations}from"@onflow/sdk-build-authorizations";export{arg,args}from"@onflow/sdk-build-arguments";export{proposer}from"@onflow/sdk-build-proposer";export{payer}from"@onflow/sdk-build-payer";export{limit}from"@onflow/sdk-build-limit";export{ref}from"@onflow/sdk-build-ref";export{param,params}from"@onflow/sdk-build-params";e().put("accessNode.api","http://localhost:8080").put("challenge.handshake","http://localhost:8700/authenticate");var x=function(e){return"function"==typeof e},A=function(e){return"string"==typeof e},R=function(e){return"function"==typeof e};function j(e){return u(null!=typeof e.xform,"No type specified for argument: "+e.value),R(e.xform)?e.xform(e.value):R(e.xform.asArgument)?e.xform.asArgument(e.value):void u(!1,"Invalid Argument",e)}var C="undefined"!=typeof Symbol?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";function N(e,r,n){if(!e.s){if(n instanceof T){if(!n.s)return void(n.o=N.bind(null,e,r));1&r&&(r=n.s),n=n.v}if(n&&n.then)return void n.then(N.bind(null,e,r),N.bind(null,e,2));e.s=r,e.v=n;var t=e.o;t&&t(e)}}var T=function(){function e(){}return e.prototype.then=function(r,n){var t=new e,o=this.s;if(o){var i=1&o?r:n;if(i){try{N(t,1,i(this.v))}catch(e){N(t,2,e)}return t}return this}return this.o=function(e){try{var o=e.v;1&e.s?N(t,1,r?r(o):o):n?N(t,1,n(o)):N(t,2,o)}catch(e){N(t,2,e)}},t},e}();function L(e){return e instanceof T&&1&e.s}var O=function e(r,n,t,o){void 0===o&&(o=3);try{var i=function(){t&&(r.authorizations=r.authorizations.map(function(e){return e===t.tempId?a:e}).reduce(function(e,r){return Array.isArray(r)?[].concat(e,r):[].concat(e,[r])},[]))};u(o,"Account Resolve Recursion Limit Exceeded",{ix:r,accounts:n});var a=[],s=function(e,r,n){if("function"==typeof e[C]){var t,o,i,u=e[C]();if(function e(n){try{for(;!(t=u.next()).done;)if((n=r(t.value))&&n.then){if(!L(n))return void n.then(e,i||(i=N.bind(null,o=new T,2)));n=n.v}o?N(o,1,n):o=n}catch(e){N(o||(o=new T),2,e)}}(),u.return){var a=function(e){try{t.done||u.return()}catch(e){}return e};if(o&&o.then)return o.then(a,function(e){throw a(e)});a()}return o}if(!("length"in e))throw new TypeError("Object is not iterable");for(var s=[],c=0;c<e.length;c++)s.push(e[c]);return function(e,r,n){var t,o,i=-1;return function n(u){try{for(;++i<e.length;)if((u=r(i))&&u.then){if(!L(u))return void u.then(n,o||(o=N.bind(null,t=new T,2)));u=u.v}t?N(t,1,u):t=u}catch(e){N(t||(t=new T),2,e)}}(),t}(s,function(e){return r(s[e])})}(n,function(n){function i(){function i(){u.tempId!=n.tempId&&delete r.accounts[u.tempId]}var s=function(){if(Array.isArray(n))return Promise.resolve(e(r,n,u,o-1)).then(function(){});r.accounts[n.tempId]=r.accounts[n.tempId]||n,r.accounts[n.tempId].role.proposer=r.accounts[n.tempId].role.proposer||n.role.proposer,r.accounts[n.tempId].role.payer=r.accounts[n.tempId].role.payer||n.role.payer,r.accounts[n.tempId].role.authorizer=r.accounts[n.tempId].role.authorizer||n.role.authorizer,r.accounts[n.tempId].role.proposer&&r.proposer===u.tempId&&(r.proposer=n.tempId),r.accounts[n.tempId].role.payer&&r.payer===u.tempId&&(r.payer=n.tempId),r.accounts[n.tempId].role.authorizer&&(t?a=[].concat(a,[n.tempId]):r.authorizations=r.authorizations.map(function(e){return e===u.tempId?n.tempId:e}))}();return s&&s.then?s.then(i):i()}var u=t||n,s=function(){if(z(n.resolve))return Promise.resolve(n.resolve(n,function(e,r){try{return{f_type:"PreSignable",f_vsn:"1.0.0",roles:e.role,cadence:r.message.cadence,args:r.message.arguments.map(function(e){return r.arguments[e].asArgument}),data:{},interaction:r}}catch(e){throw console.error("buildPreSignable",e),e}}(n,r))).then(function(e){n=e})}();return s&&s.then?s.then(i):i()});return Promise.resolve(s&&s.then?s.then(i):i())}catch(e){return Promise.reject(e)}},z=function(e){return"function"==typeof e};function _(){return(_=Object.assign||function(e){for(var r=1;r<arguments.length;r++){var n=arguments[r];for(var t in n)Object.prototype.hasOwnProperty.call(n,t)&&(e[t]=n[t])}return e}).apply(this,arguments)}function D(e,r){(null==r||r>e.length)&&(r=e.length);for(var n=0,t=new Array(r);n<r;n++)t[n]=e[n];return t}function F(e,r){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,r){if(e){if("string"==typeof e)return D(e,void 0);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?D(e,void 0):void 0}}(e))||r&&e&&"number"==typeof e.length){n&&(e=n);var t=0;return function(){return t>=e.length?{done:!0}:{done:!1,value:e[t++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(n=e[Symbol.iterator]()).next.bind(n)}var U=function(e,r){return Buffer.from(e.padStart(2*r,0),"hex")},B=function(e){return U(e,8)},M=function(e){return Buffer.from(JSON.stringify(e),"utf8")},H=function(e){return d(e).toString("hex")},J=function(e){return G(e),[(n=e.script,Buffer.from(n,"utf8")),e.arguments.map(M),(r=e.refBlock,U(r,32)),e.gasLimit,B(e.proposalKey.address),e.proposalKey.keyId,e.proposalKey.sequenceNum,B(e.payer),e.authorizers.map(B)];var r,n},q=function(e){var r=K(e);return e.payloadSigs.map(function(e){return{signerIndex:r.get(e.address),keyId:e.keyId,sig:e.sig}}).sort(function(e,r){return e.signerIndex>r.signerIndex?1:e.signerIndex<r.signerIndex?-1:e.keyId>r.keyId?1:e.keyId<r.keyId?-1:void 0}).map(function(e){return[e.signerIndex,e.keyId,(r=e.sig,Buffer.from(r,"hex"))];var r})},K=function(e){var r=new Map,n=0,t=function(e){r.has(e)||(r.set(e,n),n++)};return t(e.proposalKey.address),t(e.payer),e.authorizers.forEach(t),r},G=function(e){W.forEach(function(r){return re(e,r)}),$.forEach(function(r){return re(e.proposalKey,r,"proposalKey")})},V=function(e){return"number"==typeof e},Y=function(e){return"string"==typeof e},Z=function(e){return null!==e&&"object"==typeof e},X=function(e){return Z(e)&&e instanceof Array},W=[{name:"script",check:Y},{name:"arguments",check:X},{name:"refBlock",check:Y,defaultVal:"0"},{name:"gasLimit",check:V},{name:"proposalKey",check:Z},{name:"payer",check:Y},{name:"authorizers",check:X}],$=[{name:"address",check:Y},{name:"keyId",check:V},{name:"sequenceNum",check:V}],Q=[{name:"payloadSigs",check:X}],ee=[{name:"address",check:Y},{name:"keyId",check:V},{name:"sig",check:Y}],re=function(e,r,n,t){var o=r.name,i=r.check,u=r.defaultVal;if(null==e[o]&&null!=u&&(e[o]=u),null==e[o])throw te(o,n,t);if(!i(e[o]))throw oe(o,n,t)},ne=function(e,r,n){return r?null==n?r+"."+e:r+"."+n+"."+e:e},te=function(e,r,n){return new Error("Missing field "+ne(e,r,n))},oe=function(e,r,n){return new Error("Invalid field "+ne(e,r,n))};function ie(e,r){return function(n){try{var t=e.accounts[n];return null!=t.signature?Promise.resolve():Promise.resolve(t.signingFunction(function(e,r,n){try{return{f_type:"Signable",f_vsn:"1.0.0",message:r,addr:c(e.addr),keyId:e.keyId,roles:e.role,cadence:n.message.cadence,args:n.message.arguments.map(function(e){return n.arguments[e].asArgument}),data:{},interaction:n}}catch(e){throw console.error("buildSignable",e),e}}(t,r,e))).then(function(r){e.accounts[n].signature=r.signature})}catch(e){return Promise.reject(e)}}}function ue(e){return{script:e.message.cadence,refBlock:e.message.refBlock||null,gasLimit:e.message.computeLimit,arguments:e.message.arguments.map(function(r){return e.arguments[r].asArgument}),proposalKey:{address:c(e.accounts[e.proposer].addr),keyId:e.accounts[e.proposer].keyId,sequenceNum:e.accounts[e.proposer].sequenceNum},payer:c(e.accounts[e.payer].addr),authorizers:e.authorizations.map(function(r){return c(e.accounts[r].addr)}).reduce(function(e,r){return e.find(function(e){return e===r})?e:[].concat(e,[r])},[])}}var ae=o([function(o){try{var i=function(){if(r(o)||n(o)){var i=function(){return u(A(a),"Cadence needs to be a string at this point."),Promise.resolve(e().where(/^0x/).then(function(e){return Object.entries(e).reduce(function(e,r){return e.replace(r[0],r[1])},a)})).then(function(e){o.message.cadence=e})},a=t(o,"ix.cadence");u(x(a)||A(a),"Cadence needs to be a function or a string.");var s=function(){if(x(a))return Promise.resolve(a({})).then(function(e){a=e})}();return s&&s.then?s.then(i):i()}}();return Promise.resolve(i&&i.then?i.then(function(){return o}):o)}catch(e){return Promise.reject(e)}},function(e){try{if(r(e)||n(e))for(var t=0,o=Object.entries(e.arguments);t<o.length;t++){var i=o[t];e.arguments[i[0]].asArgument=j(i[1])}return Promise.resolve(e)}catch(e){return Promise.reject(e)}},function(e){try{var n=function(){if(r(e))return function(r,n){try{var t=Promise.resolve(O(e,Object.values(e.accounts))).then(function(){return Promise.resolve(O(e,Object.values(e.accounts))).then(function(){})})}catch(e){return n(e)}return t&&t.then?t.then(void 0,n):t}(0,function(e){throw console.error("=== SAD PANDA ===\n\n",e,"\n\n=== SAD PANDA ==="),e})}();return Promise.resolve(n&&n.then?n.then(function(r){return e}):e)}catch(e){return Promise.reject(e)}},function(e){try{var n=function(){if(r(e)&&null==e.message.refBlock)return Promise.resolve(a()).then(function(r){e.message.refBlock=r.id})}();return Promise.resolve(n&&n.then?n.then(function(){return e}):e)}catch(e){return Promise.reject(e)}},function(e){try{var n=function(){if(r(e)){var n=Object.values(e.accounts).find(function(e){return e.role.proposer});u(n,"Transactions require a proposer");var t=function(){if(null==n.sequenceNum)return Promise.resolve(s(n.addr).then(function(e){return e.keys}).then(function(e){return e.find(function(e){return e.index===n.keyId})}).then(function(e){return e.sequenceNumber})).then(function(r){e.accounts[n.tempId].sequenceNum=r})}();if(t&&t.then)return t.then(function(){})}}();return Promise.resolve(n&&n.then?n.then(function(){return e}):e)}catch(e){return Promise.reject(e)}},function(e){try{var n=function(){if(r(e))return function(r,n){try{var t=(i=function(e){var r=new Set(e.authorizations);return r.add(e.proposer),r.delete(e.payer),Array.from(r)}(e),o=ue(e),u=H(J(o)),Promise.resolve(Promise.all(i.map(ie(e,u)))).then(function(){var r=function(e){var r=new Set([e.payer]);return Array.from(r)}(e),n=function(e){return H(function(e){return function(e){Q.forEach(function(r){return re(e,r)}),e.payloadSigs.forEach(function(e,r){ee.forEach(function(n){return re(e,n,"payloadSigs",r)})})}(e),[J(e),q(e)]}(e))}(_({},ue(e),{payloadSigs:i.map(function(r){return{address:e.accounts[r].addr,keyId:e.accounts[r].keyId,sig:e.accounts[r].signature}})}));return Promise.resolve(Promise.all(r.map(ie(e,n)))).then(function(){})}))}catch(e){return n(e)}var o,i,u;return t&&t.then?t.then(void 0,n):t}(0,function(r){throw console.error("Signatures",r,{ix:e}),r})}();return Promise.resolve(n&&n.then?n.then(function(r){return e}):e)}catch(e){return Promise.reject(e)}},function(e){try{for(var r=0,n=Object.keys(e.accounts);r<n.length;r++){var t=n[r];e.accounts[t].addr=c(e.accounts[t].addr)}return Promise.resolve(e)}catch(e){return Promise.reject(e)}}]);e().put("sdk.resolve",ae);var se,ce,fe=function(r,n){void 0===r&&(r=[]),void 0===n&&(n={});try{return Promise.resolve(e().get("sdk.resolve",n.resolve||l(n))).then(function(e){function n(){return Promise.resolve(e(r)).then(function(e){return JSON.stringify(e,null,2)})}var t=function(){if(Array.isArray(r))return Promise.resolve(o(i(),r)).then(function(e){r=e})}();return t&&t.then?t.then(n):n()})}catch(e){return Promise.reject(e)}},de=function(e){try{return Promise.resolve(k([I(e)]).then(E))}catch(e){return Promise.reject(e)}},le=function(e){return e.status>=4},me=function(e){return e.status>=3},pe=function(e){return e.status>=2},he=((se={})[m]=function(e){try{return Promise.resolve(de(e.self())).then(function(r){le(r)||setTimeout(function(){return e.sendSelf("POLL")},2500),e.merge(r)})}catch(e){return Promise.reject(e)}},se[p]=function(e,r){e.subscribe(r.from),e.send(r.from,h,e.all())},se[v]=function(e,r){e.unsubscribe(r.from)},se[y]=function(e,r){try{return r.reply(e.all()),Promise.resolve()}catch(e){return Promise.reject(e)}},se.POLL=function(e){try{return Promise.resolve(de(e.self())).then(function(r){var n,t;le(r)||setTimeout(function(){return e.sendSelf("POLL")},2500),n=e.all(),t=r,JSON.stringify(n)!==JSON.stringify(t)&&e.broadcast(h,r),e.merge(r)})}catch(e){return Promise.reject(e)}},se),ve=function(e){if("object"==typeof e&&(e=e.transactionId),null==e)throw new Error("transactionId required");return e},ye=function(e){return P(he,ve(e))};function ge(e){function r(r){return g(ve(e),ye,r)}function n(e){return function(n){void 0===n&&(n={});var t=n.suppress||!1;return new Promise(function(n,o){var i=r(function(r){r.statusCode&&!t?(o(r.errorMessage),i()):e(r)&&(n(r),i())})})}}return{snapshot:function(){return b(e,ye)},subscribe:r,onceFinalized:n(pe),onceExecuted:n(me),onceSealed:n(le)}}ge.isUnknown=function(e){return e.status>=0},ge.isPending=function(e){return e.status>=1},ge.isFinalized=pe,ge.isExecuted=me,ge.isSealed=le,ge.isExpired=function(e){return 5===e.status};var Pe=function(r){try{var n=setTimeout;return Promise.resolve(e().get("fcl.eventPollRate",1e4)).then(function(e){return n(function(){return r.sendSelf("TICK")},e)})}catch(e){return Promise.reject(e)}},be=((ce={}).TICK=function(e){try{if(!e.hasSubs())return Promise.resolve();var r=e.get("hwm"),n=function(){if(null==r){var n=e.put;return Promise.resolve(a()).then(function(r){n.call(e,"hwm",r);var t=e.put;return Promise.resolve(Pe(e)).then(function(r){t.call(e,"tick",r)})})}return Promise.resolve(a()).then(function(n){return e.put("hwm",n),Promise.resolve(k([getEvents(e.self(),r.height,n.height-1)]).then(E)).then(function(r){for(var n,t=F(r);!(n=t()).done;)e.broadcast("UPDATED",n.value.data);var o=e.put;return Promise.resolve(Pe(e)).then(function(r){o.call(e,"tick",r)})})})}();return Promise.resolve(n&&n.then?n.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},ce[p]=function(e,r){try{var n=function(){e.subscribe(r.from)},t=function(){if(!e.hasSubs()){var r=e.put;return Promise.resolve(Pe(e)).then(function(n){r.call(e,"tick",n)})}}();return Promise.resolve(t&&t.then?t.then(n):n())}catch(e){return Promise.reject(e)}},ce[v]=function(e,r){e.unsubscribe(r.from),e.hasSubs()||(clearTimeout(e.get("tick")),e.delete("tick"),e.delete("hwm"))},ce),we=function(e){return P(be,e)};function ke(e){return{subscribe:function(r){return g(e,we,r)}}}var Ee={f_type:"Service",f_vsn:"1.0.0"},Ie={f_type:"Identity",f_vsn:"1.0.0"},Se={f_type:"USER",f_vsn:"1.0.0"},xe={f_type:"PollingResponse",f_vsn:"1.0.0"},Ae={f_type:"CompositeSignature",f_vsn:"1.0.0"};function Re(e){if(null==e)return null;switch(e.f_vsn){case"1.0.0":return e;default:return _({old:e},Ee,{type:"frame",endpoint:e.endpoint,params:e.params||{},data:e.data||{}})}}function je(e){if(null==e)return null;switch(e.f_vsn){case"1.0.0":return e;default:return _({},Ee,{type:"back-channel-rpc",endpoint:e.endpoint,method:e.method,params:e.params||{},data:e.data||{}})}}var Ce={"back-channel-rpc":je,"pre-authz":function(e){if(null==e)return null;switch(e.f_vsn){case"1.0.0":return e;default:return _({},Ee,{type:e.type,uid:e.id,endpoint:e.endpoint,method:e.method,identity:_({},Ie,{address:f(e.addr),keyId:e.keyId}),params:e.params,data:e.data})}},authz:function(e){if(null==e)return null;switch(e.f_vsn){case"1.0.0":return e;default:return _({},Ee,{type:e.type,uid:e.id,endpoint:e.endpoint,method:e.method,identity:_({},Ie,{address:f(e.addr),keyId:e.keyId}),params:e.params,data:e.data})}},authn:function(e){if(null==e)return null;switch(e.f_vsn){case"1.0.0":return e;default:return _({},Ee,{type:e.type,uid:e.id,endpoint:e.authn,id:e.pid,provider:{address:f(e.addr),name:e.name,icon:e.icon}})}},frame:Re};function Ne(e){return d([e.provider.address||e.provider.name||"UNSPECIFIED",e.id]).toString("hex")}function Te(e,r){return void 0===e&&(e=[]),e.find(function(e){return e.type===r})}function Le(e){var r=new URL(e.endpoint);if(r.searchParams.append("l6n",window.location.origin),null!=e.params)for(var n=0,t=Object.entries(e.params||{});n<t.length;n++){var o=t[n];r.searchParams.append(o[0],o[1])}return r}function Oe(e,r){void 0===r&&(r={});var n=r.method||"POST",t="GET"===n?void 0:JSON.stringify(r.data||e.data||{});return fetch(Le(e),{method:n,headers:_({},e.headers||{},r.headers||{},{"Content-Type":"application/json"}),body:t}).then(function(e){return e.json()})}function ze(e){if(null==e)return null;switch(e.f_vsn){case"1.0.0":return e;default:return _({},xe,{status:e.status,reason:e.reason,data:e.compositeSignature||e.data||{},updates:je(e.authorizationUpdates),local:Re((e.local||[])[0])})}}function _e(e){if(null==e)return null;switch(e.f_vsn){case"1.0.0":return e;default:return _({},Ae,{addr:c(e.addr||e.address),signature:e.signature||e.sig,keyId:e.keyId})}}var De="FCL_IFRAME",Fe=function(){},Ue=new Set(["monetizationstart","monetizationpending","monetizationprogress","monetizationstop"]);function Be(e,r){if(void 0===r&&(r={}),console.log("FRAME",{service:e,opts:r}),null==e)return{send:Fe,close:Fe};var n=r.onClose||Fe,t=r.onMessage||Fe,o=r.onReady||Fe;window.addEventListener("message",c);var i=function(e){u(!document.getElementById(De),"Attempt at triggering multiple Frames",{src:e});var r=document.createElement("iframe");return r.src=e,r.id=De,r.allow="usb *",r.frameBorder="0",r.style.cssText="\n  position:fixed;\n  top: 0px;\n  right: 0px;\n  bottom: 0px;\n  left: 0px;\n  height: 100vh;\n  width: 100vw;\n  display:block;\n  background:rgba(0,0,0,0.25);\n  z-index: 2147483647;\n  box-sizing: border-box;\n",document.body.append(r),[r,function(){document.getElementById(De)&&document.getElementById(De).remove()}]}(Le(e)),a=i[0],s=i[1];return{send:d,close:f};function c(e){try{if("object"!=typeof e.data)return;if(Ue.has(e.data.type))return;"FCL:FRAME:CLOSE"===e.data.type&&f(),"FCL:FRAME:READY"===e.data.type&&o(e,{send:d,close:f}),t(e,{send:d,close:f}),"FCL::AUTHZ_READY"===e.data.type&&o(e,{send:d,close:f}),"FCL::CHALLENGE::CANCEL"===e.data.type&&f(),"FCL::CANCEL"===e.data.type&&f()}catch(e){console.error("Frame Callback Error",e),f()}}function f(){try{window.removeEventListener("message",c),s(),n()}catch(e){console.error("Frame Close Error",e)}}function d(e){try{console.log("SEND",e),a.contentWindow.postMessage(JSON.parse(JSON.stringify(e||{})),"*")}catch(r){console.error("Frame Send Error",e,r)}}}var Me,He={"HTTP/GET":"GET","HTTP/POST":"POST"},Je=function(e){return u(He[e.method],"Invalid Service Method for type back-channel-rpc",{service:e}),He[e.method]},qe=function(e,r){try{return r.data=e.data,Promise.resolve(Oe(e,{data:r}).then(ze)).then(function(r){if("APPROVED"===r.status)return r.data;if("DECLINED"===r.status)throw new Error("Declined: "+(r.reason||"No reason supplied."));if("PENDING"===r.status){var n=!0,t=Be(r.local,{onClose:function(){n=!1}}).close;return function e(r,n){void 0===n&&(n=function(){return!0});try{if(u(r,"Missing Polling Service",{service:r}),!n())throw new Error("Externally Halted");return Promise.resolve(Oe(r,{method:Je(r)}).then(ze)).then(function(r){switch(r.status){case"APPROVED":return r.data;case"DECLINED":throw new Error("Declined: "+(r.reason||"No reason supplied."));default:return Promise.resolve(new Promise(function(e){return setTimeout(e,500)})).then(function(){return e(r.updates,n)})}})}catch(e){return Promise.reject(e)}}(r.updates,function(){return n}).then(function(e){return t(),_e(e)}).catch(function(e){throw console.error(e),t(),e})}throw console.error("Auto Decline: Invalid Response",{service:e,resp:r}),new Error("Auto Decline: Invalid Response")})}catch(e){return Promise.reject(e)}},Ke=function(e,r){try{try{return Promise.resolve(Ge[e.method](e,r))}catch(n){throw console.error("execService(service, msg)",n,{service:e,msg:r}),n}}catch(e){return Promise.reject(e)}},Ge={"HTTP/RPC":qe,"HTTP/POST":qe,"IFRAME/RPC":function(e,r){return new Promise(function(n,t){var o=S();r.data=e.data,Be(e,{onReady:function(n,t){var i=t.send;try{i({jsonrpc:"2.0",id:o,method:"fcl:sign",params:[r,e.params]})}catch(e){throw e}},onClose:function(){t("Declined: Externally Halted")},onMessage:function(e,r){var i=r.close;try{if("object"!=typeof e.data)return;if("2.0"!==e.data.jsonrpc)return;if(e.data.id!==o)return;var u=ze(e.data.result);switch(u.status){case"APPROVED":n(_e(u.data)),i();break;case"DECLINED":t("Declined: "+(u.reason||"No reason supplied")),i();break;default:t("Declined: No reason supplied"),i()}}catch(e){throw console.error("execIframeRPC onMessage error",e),e}}})})}};function Ve(e,r,n){if(!e.s){if(n instanceof Ze){if(!n.s)return void(n.o=Ve.bind(null,e,r));1&r&&(r=n.s),n=n.v}if(n&&n.then)return void n.then(Ve.bind(null,e,r),Ve.bind(null,e,2));e.s=r,e.v=n;var t=e.o;t&&t(e)}}var Ye=function(e){try{return sr(),Promise.resolve(We()).then(function(r){var n=Te(r.services,"authz"),t=Te(r.services,"pre-authz");return _({},e,t?{tempId:"CURRENT_USER",resolve:function(e,r){try{return Promise.resolve(Ke(t,r)).then(dr)}catch(e){return Promise.reject(e)}}}:{tempId:"CURRENT_USER",resolve:null,addr:c(n.identity.address),keyId:n.identity.keyId,sequenceNum:null,signature:null,signingFunction:function(e){try{return Promise.resolve(Ke(n,e))}catch(e){return Promise.reject(e)}}})})}catch(e){return Promise.reject(e)}},Ze=function(){function e(){}return e.prototype.then=function(r,n){var t=new e,o=this.s;if(o){var i=1&o?r:n;if(i){try{Ve(t,1,i(this.v))}catch(e){Ve(t,2,e)}return t}return this}return this.o=function(e){try{var o=e.v;1&e.s?Ve(t,1,r?r(o):o):n?Ve(t,1,n(o)):Ve(t,2,o)}catch(e){Ve(t,2,e)}},t},e}();function Xe(e){return e instanceof Ze&&1&e.s}var We=function(){try{return Promise.resolve(new Promise(function(r){try{return sr(),Promise.resolve(mr()).then(function(n){return n.loggedIn&&cr(n)?r(n):Promise.resolve(e().get("challenge.handshake")).then(function(e){var n,t,o,i=(n={handshake:e,l6n:window.location.origin},t=n.l6n,(o=new URL(n.handshake)).searchParams.append("l6n",t),function(e){if(!document.getElementById("FCL_IFRAME")){var r=document.createElement("iframe");return r.src=e,r.id="FCL_IFRAME",r.allow="usb *",r.frameBorder="0",r.style.cssText="\n    position:fixed;\n    top: 0px;\n    right: 0px;\n    bottom: 0px;\n    left: 0px;\n    height: 100vh;\n    width: 100vw;\n    display:block;\n    background:rgba(0,0,0,0.25);\n    z-index: 2147483647;\n    box-sizing: border-box;\n  ",document.body.append(r),[r,function(){document.getElementById("FCL_IFRAME")&&document.getElementById("FCL_IFRAME").remove()}]}}(o.href))[1];window.addEventListener("message",function e(n){var t=n.data;try{return t.type===tr||t.type===rr?(i(),window.removeEventListener("message",e),Promise.resolve()):t.type!==nr?Promise.resolve():(i(),window.removeEventListener("message",e),Promise.resolve(function(e){try{var r=(e=function(e){return e.addr=e.addr?f(e.addr):null,e.paddr=e.paddr?f(e.paddr):null,e}(e)).services||[];return Promise.resolve(function(e,r){try{if(null==e||null==r)return Promise.resolve([]);var n=new URL(e);return n.searchParams.append("code",r),Promise.resolve(fetch(n,{method:"GET",headers:{"Content-Type":"application/json"}}).then(function(e){return e.json()})).then(function(e){if(Array.isArray(e))return e;var r=[];if(Array.isArray(e.authorizations))for(var n,t=F(e.authorizations);!(n=t()).done;)r.push(_({type:"authz",keyId:e.keyId},n.value));return null!=e.provider&&r.push(_({type:"authn",id:"wallet-provider#authn"},e.provider)),r})}catch(e){return Promise.reject(e)}}(e.hks,e.code)).then(function(n){var t,o,i=(t=r,o=n,void 0===t&&(t=[]),void 0===o&&(o=[]),[].concat(t,o)).map(function(r){return function(e,r){try{return Ce[e.type](e,r)}catch(r){return console.error("Unrecognized FCL Service Type ["+e.type+"]",e,r),e}}(r,e)}),u=function(e,r){return r.find(function(e){return"authn"===e.type})}(0,i);return _({},Se,{addr:f(e.addr),cid:Ne(u),loggedIn:!0,services:i,expiresAt:e.exp})})}catch(e){return Promise.reject(e)}}(t)).then(function(e){return w($e,er,e),Promise.resolve(mr()).then(function(e){r(e)})}))}catch(e){return Promise.reject(e)}})})})}catch(e){return Promise.reject(e)}}))}catch(e){return Promise.reject(e)}},$e="CURRENT_USER",Qe="CURRENT_USER/UPDATED",er="SET_CURRENT_USER",rr="FCL::CANCEL",nr="FCL::CHALLENGE::RESPONSE",tr="FCL::CHALLENGE::CANCEL",or='{\n  "f_type": "User",\n  "f_vsn": "1.0.0",\n  "addr":null,\n  "cid":null,\n  "loggedIn":null,\n  "expiresAt":null,\n  "services":[]\n}',ir=function(e){try{return sessionStorage.setItem($e,JSON.stringify(e)),Promise.resolve(e)}catch(e){return Promise.reject(e)}},ur=function(){return e().get("persistSession",!0)},ar=((Me={})[m]=function(e){try{return e.merge(JSON.parse(or)),Promise.resolve(ur()).then(function(r){var n=function(){if(r)return Promise.resolve(function(){try{var e=JSON.parse(or),r=JSON.parse(sessionStorage.getItem($e));return null!=r&&e.f_vsn!==r.f_vsn?(sessionStorage.removeItem($e),Promise.resolve(e)):Promise.resolve(r||e)}catch(e){return Promise.reject(e)}}()).then(function(r){cr(r)&&e.merge(r)})}();if(n&&n.then)return n.then(function(){})})}catch(e){return Promise.reject(e)}},Me[p]=function(e,r){e.subscribe(r.from),e.send(r.from,Qe,_({},e.all()))},Me[v]=function(e,r){e.unsubscribe(r.from)},Me.SNAPSHOT=function(e,r){try{return r.reply(_({},e.all())),Promise.resolve()}catch(e){return Promise.reject(e)}},Me[er]=function(e,r,n){try{return e.merge(n),Promise.resolve(ur()).then(function(r){r&&ir(e.all()),e.broadcast(Qe,_({},e.all()))})}catch(e){return Promise.reject(e)}},Me.DEL_CURRENT_USER=function(e,r){try{return e.merge(JSON.parse(or)),Promise.resolve(ur()).then(function(r){r&&ir(e.all()),e.broadcast(Qe,_({},e.all()))})}catch(e){return Promise.reject(e)}},Me),sr=function(){return P(ar,$e)};function cr(e){return null==e.expiresAt||0===e.expiresAt||e.expiresAt>Date.now()}function fr(){sr(),w($e,"DEL_CURRENT_USER")}function dr(e){var r=function(e){return{f_type:"PreAuthzResponse",f_vsn:"1.0.0",proposer:(e||{}).proposer,payer:(e||{}).payer||[],authorization:(e||{}).authorization||[]}}(e),n=[];null!=r.proposer&&n.push(["PROPOSER",r.proposer]);for(var t,o=F(r.payer||[]);!(t=o()).done;)n.push(["PAYER",t.value]);for(var i,u=F(r.authorization||[]);!(i=u()).done;)n.push(["AUTHORIZER",i.value]);return n.map(function(e){var r=e[0],n=e[1];return{tempId:[n.identity.address,n.identity.keyId].join("|"),addr:n.identity.address,keyId:n.identity.keyId,signingFunction:function(e){return Ke(n,e)},role:{proposer:"PROPOSER"===r,payer:"PAYER"===r,authorizer:"AUTHORIZER"===r}}})}function lr(e){sr();var r=P(function(r){try{var n;return r.send($e,p),Promise.resolve(function(e,r,n){for(var t;;){var o=e();if(Xe(o)&&(o=o.v),!o)return i;if(o.then){t=0;break}var i=n();if(i&&i.then){if(!Xe(i)){t=1;break}i=i.s}}var u=new Ze,a=Ve.bind(null,u,2);return(0===t?o.then(c):1===t?i.then(s):(void 0).then(function(){(o=e())?o.then?o.then(c).then(void 0,a):c(o):Ve(u,1,i)})).then(void 0,a),u;function s(r){i=r;do{if(!(o=e())||Xe(o)&&!o.v)return void Ve(u,1,i);if(o.then)return void o.then(c).then(void 0,a);Xe(i=n())&&(i=i.v)}while(!i||!i.then);i.then(s).then(void 0,a)}function c(e){e?(i=n())&&i.then?i.then(s).then(void 0,a):s(i):Ve(u,1,i)}}(function(){return!n&&1},0,function(){return Promise.resolve(r.receive()).then(function(t){if("@EXIT"===t.tag)return r.send($e,v),void(n=1);e(t.data)})}))}catch(e){return Promise.reject(e)}});return function(){return w(r,"@EXIT")}}function mr(){return sr(),w($e,"SNAPSHOT",null,{expectReply:!0,timeout:0})}var pr=function(){return{authenticate:We,unauthenticate:fr,authorization:Ye,subscribe:lr,snapshot:mr}},hr=function(){return pr().authenticate()},vr=function(){return pr().unauthenticate()},yr=function(){return pr().unauthenticate(),pr().authenticate()},gr=function(){return pr().authenticate()},Pr=function(){return pr().authenticate()},br=pr().authorization,wr="0.0.67";export{wr as VERSION,hr as authenticate,br as authz,pr as currentUser,ke as events,Pr as logIn,yr as reauthenticate,fe as serialize,gr as signUp,ge as tx,vr as unauthenticate};
//# sourceMappingURL=fcl.module.js.map
