var e=require("@onflow/config"),r=require("@onflow/interaction"),n=require("@onflow/util-invariant"),t=require("@onflow/sdk-latest-block"),o=require("@onflow/sdk-account"),i=require("@onflow/util-address"),u=require("@onflow/rlp"),a=require("@onflow/sdk-resolve"),s=require("@onflow/util-actor"),c=require("@onflow/sdk-send"),f=require("@onflow/sdk-decode"),d=require("@onflow/sdk-build-transaction-status"),l=require("@onflow/sdk-build-get-events"),p=require("@onflow/util-uid"),m=require("@onflow/util-template"),h=require("@onflow/sdk-build-transaction"),v=require("@onflow/sdk-build-script"),y=require("@onflow/sdk-build-ping"),g=require("@onflow/sdk-build-get-account"),P=require("@onflow/sdk-build-get-latest-block"),b=require("@onflow/sdk-build-get-block-by-id"),w=require("@onflow/sdk-build-get-block-by-height"),E=require("@onflow/sdk-build-authorizations"),I=require("@onflow/sdk-build-arguments"),x=require("@onflow/sdk-build-proposer"),k=require("@onflow/sdk-build-payer"),S=require("@onflow/sdk-build-limit"),j=require("@onflow/sdk-build-ref"),O=require("@onflow/sdk-build-params");e.config().put("accessNode.api","http://localhost:8080").put("challenge.handshake","http://localhost:8700/authenticate");var A=function(e){return"function"==typeof e},R=function(e){return"string"==typeof e},C=function(e){return"function"==typeof e},T="undefined"!=typeof Symbol?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";function N(e,r,n){if(!e.s){if(n instanceof B){if(!n.s)return void(n.o=N.bind(null,e,r));1&r&&(r=n.s),n=n.v}if(n&&n.then)return void n.then(N.bind(null,e,r),N.bind(null,e,2));e.s=r,e.v=n;var t=e.o;t&&t(e)}}var B=function(){function e(){}return e.prototype.then=function(r,n){var t=new e,o=this.s;if(o){var i=1&o?r:n;if(i){try{N(t,1,i(this.v))}catch(e){N(t,2,e)}return t}return this}return this.o=function(e){try{var o=e.v;1&e.s?N(t,1,r?r(o):o):n?N(t,1,n(o)):N(t,2,o)}catch(e){N(t,2,e)}},t},e}();function L(e){return e instanceof B&&1&e.s}var z=function e(r,t,o,i){void 0===i&&(i=3);try{var u=function(){o&&(r.authorizations=r.authorizations.map(function(e){return e===o.tempId?a:e}).reduce(function(e,r){return Array.isArray(r)?[].concat(e,r):[].concat(e,[r])},[]))};n.invariant(i,"Account Resolve Recursion Limit Exceeded",{ix:r,accounts:t});var a=[],s=function(e,r,n){if("function"==typeof e[T]){var t,o,i,u=e[T]();if(function e(n){try{for(;!(t=u.next()).done;)if((n=r(t.value))&&n.then){if(!L(n))return void n.then(e,i||(i=N.bind(null,o=new B,2)));n=n.v}o?N(o,1,n):o=n}catch(e){N(o||(o=new B),2,e)}}(),u.return){var a=function(e){try{t.done||u.return()}catch(e){}return e};if(o&&o.then)return o.then(a,function(e){throw a(e)});a()}return o}if(!("length"in e))throw new TypeError("Object is not iterable");for(var s=[],c=0;c<e.length;c++)s.push(e[c]);return function(e,r,n){var t,o,i=-1;return function n(u){try{for(;++i<e.length;)if((u=r(i))&&u.then){if(!L(u))return void u.then(n,o||(o=N.bind(null,t=new B,2)));u=u.v}t?N(t,1,u):t=u}catch(e){N(t||(t=new B),2,e)}}(),t}(s,function(e){return r(s[e])})}(t,function(n){function t(){function t(){u.tempId!=n.tempId&&delete r.accounts[u.tempId]}var s=function(){if(Array.isArray(n))return Promise.resolve(e(r,n,u,i-1)).then(function(){});r.accounts[n.tempId]=r.accounts[n.tempId]||n,r.accounts[n.tempId].role.proposer=r.accounts[n.tempId].role.proposer||n.role.proposer,r.accounts[n.tempId].role.payer=r.accounts[n.tempId].role.payer||n.role.payer,r.accounts[n.tempId].role.authorizer=r.accounts[n.tempId].role.authorizer||n.role.authorizer,r.accounts[n.tempId].role.proposer&&r.proposer===u.tempId&&(r.proposer=n.tempId),r.accounts[n.tempId].role.payer&&r.payer===u.tempId&&(r.payer=n.tempId),r.accounts[n.tempId].role.authorizer&&(o?a=[].concat(a,[n.tempId]):r.authorizations=r.authorizations.map(function(e){return e===u.tempId?n.tempId:e}))}();return s&&s.then?s.then(t):t()}var u=o||n,s=function(){if(U(n.resolve))return Promise.resolve(n.resolve(n,function(e,r){try{return{f_type:"PreSignable",f_vsn:"1.0.0",roles:e.role,cadence:r.message.cadence,args:r.message.arguments.map(function(e){return r.arguments[e].asArgument}),data:{},interaction:r}}catch(e){throw console.error("buildPreSignable",e),e}}(n,r))).then(function(e){n=e})}();return s&&s.then?s.then(t):t()});return Promise.resolve(s&&s.then?s.then(u):u())}catch(e){return Promise.reject(e)}},U=function(e){return"function"==typeof e};function _(){return(_=Object.assign||function(e){for(var r=1;r<arguments.length;r++){var n=arguments[r];for(var t in n)Object.prototype.hasOwnProperty.call(n,t)&&(e[t]=n[t])}return e}).apply(this,arguments)}function q(e,r){(null==r||r>e.length)&&(r=e.length);for(var n=0,t=new Array(r);n<r;n++)t[n]=e[n];return t}function D(e,r){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,r){if(e){if("string"==typeof e)return q(e,void 0);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?q(e,void 0):void 0}}(e))||r&&e&&"number"==typeof e.length){n&&(e=n);var t=0;return function(){return t>=e.length?{done:!0}:{done:!1,value:e[t++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(n=e[Symbol.iterator]()).next.bind(n)}var F=function(e,r){return Buffer.from(e.padStart(2*r,0),"hex")},M=function(e){return F(e,8)},H=function(e){return Buffer.from(JSON.stringify(e),"utf8")},J=function(e){return u.encode(e).toString("hex")},K=function(e){return Y(e),[(n=e.script,Buffer.from(n,"utf8")),e.arguments.map(H),(r=e.refBlock,F(r,32)),e.gasLimit,M(e.proposalKey.address),e.proposalKey.keyId,e.proposalKey.sequenceNum,M(e.payer),e.authorizers.map(M)];var r,n},G=function(e){var r=V(e);return e.payloadSigs.map(function(e){return{signerIndex:r.get(e.address),keyId:e.keyId,sig:e.sig}}).sort(function(e,r){return e.signerIndex>r.signerIndex?1:e.signerIndex<r.signerIndex?-1:e.keyId>r.keyId?1:e.keyId<r.keyId?-1:void 0}).map(function(e){return[e.signerIndex,e.keyId,(r=e.sig,Buffer.from(r,"hex"))];var r})},V=function(e){var r=new Map,n=0,t=function(e){r.has(e)||(r.set(e,n),n++)};return t(e.proposalKey.address),t(e.payer),e.authorizers.forEach(t),r},Y=function(e){Q.forEach(function(r){return te(e,r)}),ee.forEach(function(r){return te(e.proposalKey,r,"proposalKey")})},Z=function(e){return"number"==typeof e},X=function(e){return"string"==typeof e},W=function(e){return null!==e&&"object"==typeof e},$=function(e){return W(e)&&e instanceof Array},Q=[{name:"script",check:X},{name:"arguments",check:$},{name:"refBlock",check:X,defaultVal:"0"},{name:"gasLimit",check:Z},{name:"proposalKey",check:W},{name:"payer",check:X},{name:"authorizers",check:$}],ee=[{name:"address",check:X},{name:"keyId",check:Z},{name:"sequenceNum",check:Z}],re=[{name:"payloadSigs",check:$}],ne=[{name:"address",check:X},{name:"keyId",check:Z},{name:"sig",check:X}],te=function(e,r,n,t){var o=r.name,i=r.check,u=r.defaultVal;if(null==e[o]&&null!=u&&(e[o]=u),null==e[o])throw ie(o,n,t);if(!i(e[o]))throw ue(o,n,t)},oe=function(e,r,n){return r?null==n?r+"."+e:r+"."+n+"."+e:e},ie=function(e,r,n){return new Error("Missing field "+oe(e,r,n))},ue=function(e,r,n){return new Error("Invalid field "+oe(e,r,n))};function ae(e,r){return function(n){try{var t=e.accounts[n];return null!=t.signature?Promise.resolve():Promise.resolve(t.signingFunction(function(e,r,n){try{return{f_type:"Signable",f_vsn:"1.0.0",message:r,addr:i.sansPrefix(e.addr),keyId:e.keyId,roles:e.role,cadence:n.message.cadence,args:n.message.arguments.map(function(e){return n.arguments[e].asArgument}),data:{},interaction:n}}catch(e){throw console.error("buildSignable",e),e}}(t,r,e))).then(function(r){e.accounts[n].signature=r.signature})}catch(e){return Promise.reject(e)}}}function se(e){return{script:e.message.cadence,refBlock:e.message.refBlock||null,gasLimit:e.message.computeLimit,arguments:e.message.arguments.map(function(r){return e.arguments[r].asArgument}),proposalKey:{address:i.sansPrefix(e.accounts[e.proposer].addr),keyId:e.accounts[e.proposer].keyId,sequenceNum:e.accounts[e.proposer].sequenceNum},payer:i.sansPrefix(e.accounts[e.payer].addr),authorizers:e.authorizations.map(function(r){return i.sansPrefix(e.accounts[r].addr)}).reduce(function(e,r){return e.find(function(e){return e===r})?e:[].concat(e,[r])},[])}}var ce=r.pipe([function(t){try{var o=function(){if(r.isTransaction(t)||r.isScript(t)){var o=function(){return n.invariant(R(i),"Cadence needs to be a string at this point."),Promise.resolve(e.config().where(/^0x/).then(function(e){return Object.entries(e).reduce(function(e,r){return e.replace(r[0],r[1])},i)})).then(function(e){t.message.cadence=e})},i=r.get(t,"ix.cadence");n.invariant(A(i)||R(i),"Cadence needs to be a function or a string.");var u=function(){if(A(i))return Promise.resolve(i({})).then(function(e){i=e})}();return u&&u.then?u.then(o):o()}}();return Promise.resolve(o&&o.then?o.then(function(){return t}):t)}catch(e){return Promise.reject(e)}},function(e){try{if(r.isTransaction(e)||r.isScript(e))for(var t=0,o=Object.entries(e.arguments);t<o.length;t++){var i=o[t];e.arguments[i[0]].asArgument=(n.invariant(null!=typeof(u=i[1]).xform,"No type specified for argument: "+u.value),C(u.xform)?u.xform(u.value):C(u.xform.asArgument)?u.xform.asArgument(u.value):void n.invariant(!1,"Invalid Argument",u))}return Promise.resolve(e)}catch(e){return Promise.reject(e)}var u},function(e){try{var n=function(){if(r.isTransaction(e))return function(r,n){try{var t=Promise.resolve(z(e,Object.values(e.accounts))).then(function(){return Promise.resolve(z(e,Object.values(e.accounts))).then(function(){})})}catch(e){return n(e)}return t&&t.then?t.then(void 0,n):t}(0,function(e){throw console.error("=== SAD PANDA ===\n\n",e,"\n\n=== SAD PANDA ==="),e})}();return Promise.resolve(n&&n.then?n.then(function(r){return e}):e)}catch(e){return Promise.reject(e)}},function(e){try{var n=function(){if(r.isTransaction(e)&&null==e.message.refBlock)return Promise.resolve(t.latestBlock()).then(function(r){e.message.refBlock=r.id})}();return Promise.resolve(n&&n.then?n.then(function(){return e}):e)}catch(e){return Promise.reject(e)}},function(e){try{var t=function(){if(r.isTransaction(e)){var t=Object.values(e.accounts).find(function(e){return e.role.proposer});n.invariant(t,"Transactions require a proposer");var i=function(){if(null==t.sequenceNum)return Promise.resolve(o.account(t.addr).then(function(e){return e.keys}).then(function(e){return e.find(function(e){return e.index===t.keyId})}).then(function(e){return e.sequenceNumber})).then(function(r){e.accounts[t.tempId].sequenceNum=r})}();if(i&&i.then)return i.then(function(){})}}();return Promise.resolve(t&&t.then?t.then(function(){return e}):e)}catch(e){return Promise.reject(e)}},function(e){try{var n=function(){if(r.isTransaction(e))return function(r,n){try{var t=(i=function(e){var r=new Set(e.authorizations);return r.add(e.proposer),r.delete(e.payer),Array.from(r)}(e),o=se(e),u=J(K(o)),Promise.resolve(Promise.all(i.map(ae(e,u)))).then(function(){var r=function(e){var r=new Set([e.payer]);return Array.from(r)}(e),n=function(e){return J(function(e){return function(e){re.forEach(function(r){return te(e,r)}),e.payloadSigs.forEach(function(e,r){ne.forEach(function(n){return te(e,n,"payloadSigs",r)})})}(e),[K(e),G(e)]}(e))}(_({},se(e),{payloadSigs:i.map(function(r){return{address:e.accounts[r].addr,keyId:e.accounts[r].keyId,sig:e.accounts[r].signature}})}));return Promise.resolve(Promise.all(r.map(ae(e,n)))).then(function(){})}))}catch(e){return n(e)}var o,i,u;return t&&t.then?t.then(void 0,n):t}(0,function(r){throw console.error("Signatures",r,{ix:e}),r})}();return Promise.resolve(n&&n.then?n.then(function(r){return e}):e)}catch(e){return Promise.reject(e)}},function(e){try{for(var r=0,n=Object.keys(e.accounts);r<n.length;r++){var t=n[r];e.accounts[t].addr=i.sansPrefix(e.accounts[t].addr)}return Promise.resolve(e)}catch(e){return Promise.reject(e)}}]);e.config().put("sdk.resolve",ce);var fe,de,le=function(e){try{return Promise.resolve(c.send([d.getTransactionStatus(e)]).then(f.decode))}catch(e){return Promise.reject(e)}},pe=function(e){return e.status>=4},me=function(e){return e.status>=3},he=function(e){return e.status>=2},ve=((fe={})[s.INIT]=function(e){try{return Promise.resolve(le(e.self())).then(function(r){pe(r)||setTimeout(function(){return e.sendSelf("POLL")},2500),e.merge(r)})}catch(e){return Promise.reject(e)}},fe[s.SUBSCRIBE]=function(e,r){e.subscribe(r.from),e.send(r.from,s.UPDATED,e.all())},fe[s.UNSUBSCRIBE]=function(e,r){e.unsubscribe(r.from)},fe[s.SNAPSHOT]=function(e,r){try{return r.reply(e.all()),Promise.resolve()}catch(e){return Promise.reject(e)}},fe.POLL=function(e){try{return Promise.resolve(le(e.self())).then(function(r){var n,t;pe(r)||setTimeout(function(){return e.sendSelf("POLL")},2500),n=e.all(),t=r,JSON.stringify(n)!==JSON.stringify(t)&&e.broadcast(s.UPDATED,r),e.merge(r)})}catch(e){return Promise.reject(e)}},fe),ye=function(e){if("object"==typeof e&&(e=e.transactionId),null==e)throw new Error("transactionId required");return e},ge=function(e){return s.spawn(ve,ye(e))};function Pe(e){function r(r){return s.subscriber(ye(e),ge,r)}function n(e){return function(n){void 0===n&&(n={});var t=n.suppress||!1;return new Promise(function(n,o){var i=r(function(r){r.statusCode&&!t?(o(r.errorMessage),i()):e(r)&&(n(r),i())})})}}return{snapshot:function(){return s.snapshoter(e,ge)},subscribe:r,onceFinalized:n(he),onceExecuted:n(me),onceSealed:n(pe)}}Pe.isUnknown=function(e){return e.status>=0},Pe.isPending=function(e){return e.status>=1},Pe.isFinalized=he,Pe.isExecuted=me,Pe.isSealed=pe,Pe.isExpired=function(e){return 5===e.status};var be=function(r){try{var n=setTimeout;return Promise.resolve(e.config().get("fcl.eventPollRate",1e4)).then(function(e){return n(function(){return r.sendSelf("TICK")},e)})}catch(e){return Promise.reject(e)}},we=((de={}).TICK=function(e){try{if(!e.hasSubs())return Promise.resolve();var r=e.get("hwm"),n=function(){if(null==r){var n=e.put;return Promise.resolve(t.latestBlock()).then(function(r){n.call(e,"hwm",r);var t=e.put;return Promise.resolve(be(e)).then(function(r){t.call(e,"tick",r)})})}return Promise.resolve(t.latestBlock()).then(function(n){return e.put("hwm",n),Promise.resolve(c.send([getEvents(e.self(),r.height,n.height-1)]).then(f.decode)).then(function(r){for(var n,t=D(r);!(n=t()).done;)e.broadcast("UPDATED",n.value.data);var o=e.put;return Promise.resolve(be(e)).then(function(r){o.call(e,"tick",r)})})})}();return Promise.resolve(n&&n.then?n.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},de[s.SUBSCRIBE]=function(e,r){try{var n=function(){e.subscribe(r.from)},t=function(){if(!e.hasSubs()){var r=e.put;return Promise.resolve(be(e)).then(function(n){r.call(e,"tick",n)})}}();return Promise.resolve(t&&t.then?t.then(n):n())}catch(e){return Promise.reject(e)}},de[s.UNSUBSCRIBE]=function(e,r){e.unsubscribe(r.from),e.hasSubs()||(clearTimeout(e.get("tick")),e.delete("tick"),e.delete("hwm"))},de),Ee=function(e){return s.spawn(we,e)},Ie={f_type:"Service",f_vsn:"1.0.0"},xe={f_type:"Identity",f_vsn:"1.0.0"},ke={f_type:"USER",f_vsn:"1.0.0"},Se={f_type:"PollingResponse",f_vsn:"1.0.0"},je={f_type:"CompositeSignature",f_vsn:"1.0.0"};function Oe(e){if(null==e)return null;switch(e.f_vsn){case"1.0.0":return e;default:return _({old:e},Ie,{type:"frame",endpoint:e.endpoint,params:e.params||{},data:e.data||{}})}}function Ae(e){if(null==e)return null;switch(e.f_vsn){case"1.0.0":return e;default:return _({},Ie,{type:"back-channel-rpc",endpoint:e.endpoint,method:e.method,params:e.params||{},data:e.data||{}})}}var Re={"back-channel-rpc":Ae,"pre-authz":function(e){if(null==e)return null;switch(e.f_vsn){case"1.0.0":return e;default:return _({},Ie,{type:e.type,uid:e.id,endpoint:e.endpoint,method:e.method,identity:_({},xe,{address:i.withPrefix(e.addr),keyId:e.keyId}),params:e.params,data:e.data})}},authz:function(e){if(null==e)return null;switch(e.f_vsn){case"1.0.0":return e;default:return _({},Ie,{type:e.type,uid:e.id,endpoint:e.endpoint,method:e.method,identity:_({},xe,{address:i.withPrefix(e.addr),keyId:e.keyId}),params:e.params,data:e.data})}},authn:function(e){if(null==e)return null;switch(e.f_vsn){case"1.0.0":return e;default:return _({},Ie,{type:e.type,uid:e.id,endpoint:e.authn,id:e.pid,provider:{address:i.withPrefix(e.addr),name:e.name,icon:e.icon}})}},frame:Oe};function Ce(e){return u.encode([e.provider.address||e.provider.name||"UNSPECIFIED",e.id]).toString("hex")}function Te(e,r){return void 0===e&&(e=[]),e.find(function(e){return e.type===r})}function Ne(e){var r=new URL(e.endpoint);if(r.searchParams.append("l6n",window.location.origin),null!=e.params)for(var n=0,t=Object.entries(e.params||{});n<t.length;n++){var o=t[n];r.searchParams.append(o[0],o[1])}return r}function Be(e,r){void 0===r&&(r={});var n=r.method||"POST",t="GET"===n?void 0:JSON.stringify(r.data||e.data||{});return fetch(Ne(e),{method:n,headers:_({},e.headers||{},r.headers||{},{"Content-Type":"application/json"}),body:t}).then(function(e){return e.json()})}function Le(e){if(null==e)return null;switch(e.f_vsn){case"1.0.0":return e;default:return _({},Se,{status:e.status,reason:e.reason,data:e.compositeSignature||e.data||{},updates:Ae(e.authorizationUpdates),local:Oe((e.local||[])[0])})}}function ze(e){if(null==e)return null;switch(e.f_vsn){case"1.0.0":return e;default:return _({},je,{addr:i.sansPrefix(e.addr||e.address),signature:e.signature||e.sig,keyId:e.keyId})}}var Ue="FCL_IFRAME",_e=function(){},qe=new Set(["monetizationstart","monetizationpending","monetizationprogress","monetizationstop"]);function De(e,r){if(void 0===r&&(r={}),console.log("FRAME",{service:e,opts:r}),null==e)return{send:_e,close:_e};var t=r.onClose||_e,o=r.onMessage||_e,i=r.onReady||_e;window.addEventListener("message",c);var u=function(e){n.invariant(!document.getElementById(Ue),"Attempt at triggering multiple Frames",{src:e});var r=document.createElement("iframe");return r.src=e,r.id=Ue,r.allow="usb *",r.frameBorder="0",r.style.cssText="\n  position:fixed;\n  top: 0px;\n  right: 0px;\n  bottom: 0px;\n  left: 0px;\n  height: 100vh;\n  width: 100vw;\n  display:block;\n  background:rgba(0,0,0,0.25);\n  z-index: 2147483647;\n  box-sizing: border-box;\n",document.body.append(r),[r,function(){document.getElementById(Ue)&&document.getElementById(Ue).remove()}]}(Ne(e)),a=u[0],s=u[1];return{send:d,close:f};function c(e){try{if("object"!=typeof e.data)return;if(qe.has(e.data.type))return;"FCL:FRAME:CLOSE"===e.data.type&&f(),"FCL:FRAME:READY"===e.data.type&&i(e,{send:d,close:f}),o(e,{send:d,close:f}),"FCL::AUTHZ_READY"===e.data.type&&i(e,{send:d,close:f}),"FCL::CHALLENGE::CANCEL"===e.data.type&&f(),"FCL::CANCEL"===e.data.type&&f()}catch(e){console.error("Frame Callback Error",e),f()}}function f(){try{window.removeEventListener("message",c),s(),t()}catch(e){console.error("Frame Close Error",e)}}function d(e){try{console.log("SEND",e),a.contentWindow.postMessage(JSON.parse(JSON.stringify(e||{})),"*")}catch(r){console.error("Frame Send Error",e,r)}}}var Fe,Me={"HTTP/GET":"GET","HTTP/POST":"POST"},He=function(e){return n.invariant(Me[e.method],"Invalid Service Method for type back-channel-rpc",{service:e}),Me[e.method]},Je=function(e,r){try{return r.data=e.data,Promise.resolve(Be(e,{data:r}).then(Le)).then(function(r){if("APPROVED"===r.status)return r.data;if("DECLINED"===r.status)throw new Error("Declined: "+(r.reason||"No reason supplied."));if("PENDING"===r.status){var t=!0,o=De(r.local,{onClose:function(){t=!1}}).close;return function e(r,t){void 0===t&&(t=function(){return!0});try{if(n.invariant(r,"Missing Polling Service",{service:r}),!t())throw new Error("Externally Halted");return Promise.resolve(Be(r,{method:He(r)}).then(Le)).then(function(r){switch(r.status){case"APPROVED":return r.data;case"DECLINED":throw new Error("Declined: "+(r.reason||"No reason supplied."));default:return Promise.resolve(new Promise(function(e){return setTimeout(e,500)})).then(function(){return e(r.updates,t)})}})}catch(e){return Promise.reject(e)}}(r.updates,function(){return t}).then(function(e){return o(),ze(e)}).catch(function(e){throw console.error(e),o(),e})}throw console.error("Auto Decline: Invalid Response",{service:e,resp:r}),new Error("Auto Decline: Invalid Response")})}catch(e){return Promise.reject(e)}},Ke=function(e,r){try{try{return Promise.resolve(Ge[e.method](e,r))}catch(n){throw console.error("execService(service, msg)",n,{service:e,msg:r}),n}}catch(e){return Promise.reject(e)}},Ge={"HTTP/RPC":Je,"HTTP/POST":Je,"IFRAME/RPC":function(e,r){return new Promise(function(n,t){var o=p.uid();r.data=e.data,De(e,{onReady:function(n,t){var i=t.send;try{i({jsonrpc:"2.0",id:o,method:"fcl:sign",params:[r,e.params]})}catch(e){throw e}},onClose:function(){t("Declined: Externally Halted")},onMessage:function(e,r){var i=r.close;try{if("object"!=typeof e.data)return;if("2.0"!==e.data.jsonrpc)return;if(e.data.id!==o)return;var u=Le(e.data.result);switch(u.status){case"APPROVED":n(ze(u.data)),i();break;case"DECLINED":t("Declined: "+(u.reason||"No reason supplied")),i();break;default:t("Declined: No reason supplied"),i()}}catch(e){throw console.error("execIframeRPC onMessage error",e),e}}})})}};function Ve(e,r,n){if(!e.s){if(n instanceof Ze){if(!n.s)return void(n.o=Ve.bind(null,e,r));1&r&&(r=n.s),n=n.v}if(n&&n.then)return void n.then(Ve.bind(null,e,r),Ve.bind(null,e,2));e.s=r,e.v=n;var t=e.o;t&&t(e)}}var Ye=function(e){try{return sr(),Promise.resolve(We()).then(function(r){var n=Te(r.services,"authz"),t=Te(r.services,"pre-authz");return _({},e,t?{tempId:"CURRENT_USER",resolve:function(e,r){try{return Promise.resolve(Ke(t,r)).then(dr)}catch(e){return Promise.reject(e)}}}:{tempId:"CURRENT_USER",resolve:null,addr:i.sansPrefix(n.identity.address),keyId:n.identity.keyId,sequenceNum:null,signature:null,signingFunction:function(e){try{return Promise.resolve(Ke(n,e))}catch(e){return Promise.reject(e)}}})})}catch(e){return Promise.reject(e)}},Ze=function(){function e(){}return e.prototype.then=function(r,n){var t=new e,o=this.s;if(o){var i=1&o?r:n;if(i){try{Ve(t,1,i(this.v))}catch(e){Ve(t,2,e)}return t}return this}return this.o=function(e){try{var o=e.v;1&e.s?Ve(t,1,r?r(o):o):n?Ve(t,1,n(o)):Ve(t,2,o)}catch(e){Ve(t,2,e)}},t},e}();function Xe(e){return e instanceof Ze&&1&e.s}var We=function(){try{return Promise.resolve(new Promise(function(r){try{return sr(),Promise.resolve(pr()).then(function(n){return n.loggedIn&&cr(n)?r(n):Promise.resolve(e.config().get("challenge.handshake")).then(function(e){var n,t,o,u=(n={handshake:e,l6n:window.location.origin},t=n.l6n,(o=new URL(n.handshake)).searchParams.append("l6n",t),function(e){if(!document.getElementById("FCL_IFRAME")){var r=document.createElement("iframe");return r.src=e,r.id="FCL_IFRAME",r.allow="usb *",r.frameBorder="0",r.style.cssText="\n    position:fixed;\n    top: 0px;\n    right: 0px;\n    bottom: 0px;\n    left: 0px;\n    height: 100vh;\n    width: 100vw;\n    display:block;\n    background:rgba(0,0,0,0.25);\n    z-index: 2147483647;\n    box-sizing: border-box;\n  ",document.body.append(r),[r,function(){document.getElementById("FCL_IFRAME")&&document.getElementById("FCL_IFRAME").remove()}]}}(o.href))[1];window.addEventListener("message",function e(n){var t=n.data;try{return t.type===tr||t.type===rr?(u(),window.removeEventListener("message",e),Promise.resolve()):t.type!==nr?Promise.resolve():(u(),window.removeEventListener("message",e),Promise.resolve(function(e){try{var r=(e=function(e){return e.addr=e.addr?i.withPrefix(e.addr):null,e.paddr=e.paddr?i.withPrefix(e.paddr):null,e}(e)).services||[];return Promise.resolve(function(e,r){try{if(null==e||null==r)return Promise.resolve([]);var n=new URL(e);return n.searchParams.append("code",r),Promise.resolve(fetch(n,{method:"GET",headers:{"Content-Type":"application/json"}}).then(function(e){return e.json()})).then(function(e){if(Array.isArray(e))return e;var r=[];if(Array.isArray(e.authorizations))for(var n,t=D(e.authorizations);!(n=t()).done;)r.push(_({type:"authz",keyId:e.keyId},n.value));return null!=e.provider&&r.push(_({type:"authn",id:"wallet-provider#authn"},e.provider)),r})}catch(e){return Promise.reject(e)}}(e.hks,e.code)).then(function(n){var t,o,u=(t=r,o=n,void 0===t&&(t=[]),void 0===o&&(o=[]),[].concat(t,o)).map(function(r){return function(e,r){try{return Re[e.type](e,r)}catch(r){return console.error("Unrecognized FCL Service Type ["+e.type+"]",e,r),e}}(r,e)}),a=function(e,r){return r.find(function(e){return"authn"===e.type})}(0,u);return _({},ke,{addr:i.withPrefix(e.addr),cid:Ce(a),loggedIn:!0,services:u,expiresAt:e.exp})})}catch(e){return Promise.reject(e)}}(t)).then(function(e){return s.send($e,er,e),Promise.resolve(pr()).then(function(e){r(e)})}))}catch(e){return Promise.reject(e)}})})})}catch(e){return Promise.reject(e)}}))}catch(e){return Promise.reject(e)}},$e="CURRENT_USER",Qe="CURRENT_USER/UPDATED",er="SET_CURRENT_USER",rr="FCL::CANCEL",nr="FCL::CHALLENGE::RESPONSE",tr="FCL::CHALLENGE::CANCEL",or='{\n  "f_type": "User",\n  "f_vsn": "1.0.0",\n  "addr":null,\n  "cid":null,\n  "loggedIn":null,\n  "expiresAt":null,\n  "services":[]\n}',ir=function(e){try{return sessionStorage.setItem($e,JSON.stringify(e)),Promise.resolve(e)}catch(e){return Promise.reject(e)}},ur=function(){return e.config().get("persistSession",!0)},ar=((Fe={})[s.INIT]=function(e){try{return e.merge(JSON.parse(or)),Promise.resolve(ur()).then(function(r){var n=function(){if(r)return Promise.resolve(function(){try{var e=JSON.parse(or),r=JSON.parse(sessionStorage.getItem($e));return null!=r&&e.f_vsn!==r.f_vsn?(sessionStorage.removeItem($e),Promise.resolve(e)):Promise.resolve(r||e)}catch(e){return Promise.reject(e)}}()).then(function(r){cr(r)&&e.merge(r)})}();if(n&&n.then)return n.then(function(){})})}catch(e){return Promise.reject(e)}},Fe[s.SUBSCRIBE]=function(e,r){e.subscribe(r.from),e.send(r.from,Qe,_({},e.all()))},Fe[s.UNSUBSCRIBE]=function(e,r){e.unsubscribe(r.from)},Fe.SNAPSHOT=function(e,r){try{return r.reply(_({},e.all())),Promise.resolve()}catch(e){return Promise.reject(e)}},Fe[er]=function(e,r,n){try{return e.merge(n),Promise.resolve(ur()).then(function(r){r&&ir(e.all()),e.broadcast(Qe,_({},e.all()))})}catch(e){return Promise.reject(e)}},Fe.DEL_CURRENT_USER=function(e,r){try{return e.merge(JSON.parse(or)),Promise.resolve(ur()).then(function(r){r&&ir(e.all()),e.broadcast(Qe,_({},e.all()))})}catch(e){return Promise.reject(e)}},Fe),sr=function(){return s.spawn(ar,$e)};function cr(e){return null==e.expiresAt||0===e.expiresAt||e.expiresAt>Date.now()}function fr(){sr(),s.send($e,"DEL_CURRENT_USER")}function dr(e){var r=function(e){return{f_type:"PreAuthzResponse",f_vsn:"1.0.0",proposer:(e||{}).proposer,payer:(e||{}).payer||[],authorization:(e||{}).authorization||[]}}(e),n=[];null!=r.proposer&&n.push(["PROPOSER",r.proposer]);for(var t,o=D(r.payer||[]);!(t=o()).done;)n.push(["PAYER",t.value]);for(var i,u=D(r.authorization||[]);!(i=u()).done;)n.push(["AUTHORIZER",i.value]);return n.map(function(e){var r=e[0],n=e[1];return{tempId:[n.identity.address,n.identity.keyId].join("|"),addr:n.identity.address,keyId:n.identity.keyId,signingFunction:function(e){return Ke(n,e)},role:{proposer:"PROPOSER"===r,payer:"PAYER"===r,authorizer:"AUTHORIZER"===r}}})}function lr(e){sr();var r=s.spawn(function(r){try{var n;return r.send($e,s.SUBSCRIBE),Promise.resolve(function(e,r,n){for(var t;;){var o=e();if(Xe(o)&&(o=o.v),!o)return i;if(o.then){t=0;break}var i=n();if(i&&i.then){if(!Xe(i)){t=1;break}i=i.s}}var u=new Ze,a=Ve.bind(null,u,2);return(0===t?o.then(c):1===t?i.then(s):(void 0).then(function(){(o=e())?o.then?o.then(c).then(void 0,a):c(o):Ve(u,1,i)})).then(void 0,a),u;function s(r){i=r;do{if(!(o=e())||Xe(o)&&!o.v)return void Ve(u,1,i);if(o.then)return void o.then(c).then(void 0,a);Xe(i=n())&&(i=i.v)}while(!i||!i.then);i.then(s).then(void 0,a)}function c(e){e?(i=n())&&i.then?i.then(s).then(void 0,a):s(i):Ve(u,1,i)}}(function(){return!n&&1},0,function(){return Promise.resolve(r.receive()).then(function(t){if("@EXIT"===t.tag)return r.send($e,s.UNSUBSCRIBE),void(n=1);e(t.data)})}))}catch(e){return Promise.reject(e)}});return function(){return s.send(r,"@EXIT")}}function pr(){return sr(),s.send($e,"SNAPSHOT",null,{expectReply:!0,timeout:0})}var mr=function(){return{authenticate:We,unauthenticate:fr,authorization:Ye,subscribe:lr,snapshot:pr}},hr=mr().authorization;Object.defineProperty(exports,"config",{enumerable:!0,get:function(){return e.config}}),Object.defineProperty(exports,"isBad",{enumerable:!0,get:function(){return r.isBad}}),Object.defineProperty(exports,"isOk",{enumerable:!0,get:function(){return r.isOk}}),Object.defineProperty(exports,"pipe",{enumerable:!0,get:function(){return r.pipe}}),Object.defineProperty(exports,"why",{enumerable:!0,get:function(){return r.why}}),Object.defineProperty(exports,"latestBlock",{enumerable:!0,get:function(){return t.latestBlock}}),Object.defineProperty(exports,"account",{enumerable:!0,get:function(){return o.account}}),Object.defineProperty(exports,"display",{enumerable:!0,get:function(){return i.display}}),Object.defineProperty(exports,"sansPrefix",{enumerable:!0,get:function(){return i.sansPrefix}}),Object.defineProperty(exports,"withPrefix",{enumerable:!0,get:function(){return i.withPrefix}}),Object.defineProperty(exports,"send",{enumerable:!0,get:function(){return c.send}}),Object.defineProperty(exports,"decode",{enumerable:!0,get:function(){return f.decode}}),Object.defineProperty(exports,"getTransactionStatus",{enumerable:!0,get:function(){return d.getTransactionStatus}}),Object.defineProperty(exports,"getEvents",{enumerable:!0,get:function(){return l.getEvents}}),Object.defineProperty(exports,"cadence",{enumerable:!0,get:function(){return m.template}}),Object.defineProperty(exports,"cdc",{enumerable:!0,get:function(){return m.template}}),Object.defineProperty(exports,"transaction",{enumerable:!0,get:function(){return h.transaction}}),Object.defineProperty(exports,"script",{enumerable:!0,get:function(){return v.script}}),Object.defineProperty(exports,"ping",{enumerable:!0,get:function(){return y.ping}}),Object.defineProperty(exports,"getAccount",{enumerable:!0,get:function(){return g.getAccount}}),Object.defineProperty(exports,"getLatestBlock",{enumerable:!0,get:function(){return P.getLatestBlock}}),Object.defineProperty(exports,"getBlockById",{enumerable:!0,get:function(){return b.getBlockById}}),Object.defineProperty(exports,"getBlockByHeight",{enumerable:!0,get:function(){return w.getBlockByHeight}}),Object.defineProperty(exports,"authorization",{enumerable:!0,get:function(){return E.authorization}}),Object.defineProperty(exports,"authorizations",{enumerable:!0,get:function(){return E.authorizations}}),Object.defineProperty(exports,"arg",{enumerable:!0,get:function(){return I.arg}}),Object.defineProperty(exports,"args",{enumerable:!0,get:function(){return I.args}}),Object.defineProperty(exports,"proposer",{enumerable:!0,get:function(){return x.proposer}}),Object.defineProperty(exports,"payer",{enumerable:!0,get:function(){return k.payer}}),Object.defineProperty(exports,"limit",{enumerable:!0,get:function(){return S.limit}}),Object.defineProperty(exports,"ref",{enumerable:!0,get:function(){return j.ref}}),Object.defineProperty(exports,"param",{enumerable:!0,get:function(){return O.param}}),Object.defineProperty(exports,"params",{enumerable:!0,get:function(){return O.params}}),exports.VERSION="0.0.67",exports.authenticate=function(){return mr().authenticate()},exports.authz=hr,exports.currentUser=mr,exports.events=function(e){return{subscribe:function(r){return s.subscriber(e,Ee,r)}}},exports.logIn=function(){return mr().authenticate()},exports.reauthenticate=function(){return mr().unauthenticate(),mr().authenticate()},exports.serialize=function(n,t){void 0===n&&(n=[]),void 0===t&&(t={});try{return Promise.resolve(e.config().get("sdk.resolve",t.resolve||a.resolve(t))).then(function(e){function t(){return Promise.resolve(e(n)).then(function(e){return JSON.stringify(e,null,2)})}var o=function(){if(Array.isArray(n))return Promise.resolve(r.pipe(r.interaction(),n)).then(function(e){n=e})}();return o&&o.then?o.then(t):t()})}catch(e){return Promise.reject(e)}},exports.signUp=function(){return mr().authenticate()},exports.tx=Pe,exports.unauthenticate=function(){return mr().unauthenticate()};
//# sourceMappingURL=fcl.js.map
